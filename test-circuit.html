<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircuitsAI SVG电路图渲染测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .circuit-viewer {
            border: 2px dashed #ddd;
            padding: 20px;
            background: #fafafa;
            min-height: 400px;
            overflow: auto;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #40a9ff;
        }
        .ascii-input {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            resize: vertical;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        .error {
            background: #fff2f0;
            border-color: #ffccc7;
            color: #cf1322;
        }
        h1 {
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        h2 {
            color: #595959;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 CircuitsAI SVG电路图渲染测试</h1>
        
        <div class="section">
            <h2>📋 测试内容</h2>
            <ul>
                <li>✅ 增强的电路符号库 (电阻、电容、LED、运放、MOSFET等)</li>
                <li>✅ 智能ASCII电路图解析</li>
                <li>✅ 自动布局算法 (按组件类型分层排布)</li>
                <li>✅ SVG渲染和交互控制</li>
                <li>✅ 智能连线算法</li>
            </ul>
        </div>

        <div class="section">
            <h2>🎨 示例电路 - 基础LED指示灯</h2>
            <div class="controls">
                <button onclick="loadExampleCircuit()">加载示例电路</button>
                <button onclick="loadComplexCircuit()">加载复杂电路</button>
                <button onclick="toggleTheme()">切换主题</button>
                <button onclick="exportSVG()">导出SVG</button>
            </div>
            <div id="status" class="status" style="display: none;"></div>
            <div id="circuit1" class="circuit-viewer"></div>
        </div>

        <div class="section">
            <h2>📝 ASCII电路图解析测试</h2>
            <textarea id="asciiInput" class="ascii-input" placeholder="输入ASCII电路图，例如：
VCC ----+---- [R1(220Ω)] ----+---- [LED1] ---- GND
        |                    |
      [C1]                 [R2]
        |                    |
       GND                 [LED2] ---- GND"></textarea>
            <div class="controls">
                <button onclick="parseASCII()">解析ASCII电路图</button>
                <button onclick="clearASCII()">清空</button>
            </div>
            <div id="circuit2" class="circuit-viewer"></div>
        </div>

        <div class="section">
            <h2>📊 组件库预览</h2>
            <div class="controls">
                <button onclick="showAllComponents()">显示所有组件</button>
                <button onclick="showByCategory('passive')">被动器件</button>
                <button onclick="showByCategory('semiconductor')">半导体器件</button>
                <button onclick="showByCategory('power')">电源器件</button>
            </div>
            <div id="circuit3" class="circuit-viewer"></div>
        </div>
    </div>

    <script type="module">
        // 模拟 CircuitRenderer (实际应用中通过import导入)
        class MockCircuitRenderer {
            constructor() {
                this.currentTheme = 'light';
                this.symbols = new Map();
                this.initializeSymbols();
            }

            initializeSymbols() {
                // 模拟电路符号定义
                const symbols = [
                    { id: 'resistor', name: '电阻', category: 'passive' },
                    { id: 'capacitor', name: '电容', category: 'passive' },
                    { id: 'inductor', name: '电感', category: 'passive' },
                    { id: 'led', name: 'LED', category: 'semiconductor' },
                    { id: 'diode', name: '二极管', category: 'semiconductor' },
                    { id: 'npn_transistor', name: 'NPN晶体管', category: 'semiconductor' },
                    { id: 'mosfet_n', name: 'N-MOSFET', category: 'semiconductor' },
                    { id: 'opamp', name: '运算放大器', category: 'analog_ic' },
                    { id: 'vcc', name: '电源', category: 'power' },
                    { id: 'ground', name: '地', category: 'power' },
                    { id: 'switch', name: '开关', category: 'passive' },
                    { id: 'fuse', name: '保险丝', category: 'passive' },
                    { id: 'crystal', name: '晶振', category: 'passive' },
                    { id: 'voltage_source', name: '电压源', category: 'power' }
                ];
                
                symbols.forEach(symbol => {
                    this.symbols.set(symbol.id, symbol);
                });
            }

            generateExampleCircuit() {
                return {
                    title: "LED指示灯电路",
                    components: [
                        { id: 'VCC', type: 'vcc', value: '+5V' },
                        { id: 'R1', type: 'resistor', value: '220Ω' },
                        { id: 'LED1', type: 'led', value: '红色LED' },
                        { id: 'GND', type: 'ground' }
                    ],
                    connections: ['VCC→R1→LED1→GND']
                };
            }

            generateComplexCircuit() {
                return {
                    title: "运放放大器电路",
                    components: [
                        { id: 'VCC', type: 'vcc', value: '+12V' },
                        { id: 'VEE', type: 'vcc', value: '-12V' },
                        { id: 'U1', type: 'opamp', value: 'LM741' },
                        { id: 'R1', type: 'resistor', value: '10kΩ' },
                        { id: 'R2', type: 'resistor', value: '100kΩ' },
                        { id: 'C1', type: 'capacitor', value: '100nF' },
                        { id: 'Q1', type: 'npn_transistor', value: '2N2222' },
                        { id: 'M1', type: 'mosfet_n', value: 'IRF540' },
                        { id: 'SW1', type: 'switch', value: '按键开关' },
                        { id: 'F1', type: 'fuse', value: '1A' },
                        { id: 'X1', type: 'crystal', value: '16MHz' },
                        { id: 'GND', type: 'ground' }
                    ],
                    connections: ['复杂连接关系...']
                };
            }

            renderCircuit(circuit, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const isDark = this.currentTheme === 'dark';
                const bgColor = isDark ? '#1a1a1a' : '#ffffff';
                const textColor = isDark ? '#ffffff' : '#000000';
                const gridColor = isDark ? '#333333' : '#dddddd';

                let html = `
                    <div style="background: ${bgColor}; color: ${textColor}; padding: 20px; border-radius: 8px; min-height: 300px;">
                        <h3 style="margin-top: 0; color: #1890ff;">${circuit.title}</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                `;

                // 按类别排列组件
                const categories = {
                    'power': [],
                    'analog_ic': [],
                    'semiconductor': [],
                    'passive': []
                };

                circuit.components.forEach(comp => {
                    const symbol = this.symbols.get(comp.type);
                    if (symbol) {
                        categories[symbol.category]?.push(comp);
                    }
                });

                // 渲染各类别的组件
                Object.entries(categories).forEach(([category, components]) => {
                    if (components.length > 0) {
                        html += `<div style="margin: 10px 0;">`;
                        html += `<div style="font-size: 12px; color: #666; margin-bottom: 5px;">${this.getCategoryName(category)}</div>`;
                        components.forEach(comp => {
                            html += this.renderComponent(comp);
                        });
                        html += `</div>`;
                    }
                });

                html += `
                        </div>
                        <div style="margin-top: 20px; padding: 10px; background: ${isDark ? '#2a2a2a' : '#f5f5f5'}; border-radius: 4px;">
                            <strong>连接关系:</strong> ${circuit.connections.join(', ')}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            ⚡ 智能布局: 按组件类型分层排布 | 🔗 自动连线: 电源→信号→地 | 🎨 主题: ${this.currentTheme}
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            }

            renderComponent(comp) {
                const symbol = this.symbols.get(comp.type);
                const emoji = this.getComponentEmoji(comp.type);
                
                return `
                    <div style="
                        display: inline-block; 
                        margin: 5px; 
                        padding: 10px; 
                        border: 2px solid #1890ff; 
                        border-radius: 8px; 
                        background: linear-gradient(135deg, #e6f7ff, #bae7ff);
                        text-align: center;
                        min-width: 80px;
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 20px;">${emoji}</div>
                        <div style="font-weight: bold; margin: 5px 0;">${comp.id}</div>
                        <div style="font-size: 11px; color: #666;">${symbol?.name || comp.type}</div>
                        ${comp.value ? `<div style="font-size: 10px; color: #1890ff; font-weight: bold;">${comp.value}</div>` : ''}
                    </div>
                `;
            }

            getComponentEmoji(type) {
                const emojis = {
                    'resistor': '🔗',
                    'capacitor': '⚡',
                    'inductor': '🌀',
                    'led': '💡',
                    'diode': '🔺',
                    'npn_transistor': '🔄',
                    'mosfet_n': '⚙️',
                    'opamp': '🔺',
                    'vcc': '🔋',
                    'ground': '⬇️',
                    'switch': '🔘',
                    'fuse': '🛡️',
                    'crystal': '💎',
                    'voltage_source': '🔌'
                };
                return emojis[type] || '🔧';
            }

            getCategoryName(category) {
                const names = {
                    'power': '电源器件',
                    'analog_ic': '模拟IC',
                    'semiconductor': '半导体器件',
                    'passive': '被动器件'
                };
                return names[category] || category;
            }

            parseASCIICircuit(ascii) {
                const lines = ascii.split('\\n').filter(line => line.trim());
                const components = [];
                
                // 简单的ASCII解析逻辑
                lines.forEach(line => {
                    const matches = line.match(/\\[([^\\]]+)\\]/g);
                    if (matches) {
                        matches.forEach(match => {
                            const content = match.replace(/[\\[\\]]/g, '');
                            const [name, value] = content.split(/[（\\(]/);
                            const cleanValue = value ? value.replace(/[）\\)]/g, '') : '';
                            
                            if (!components.find(c => c.id === name)) {
                                components.push({
                                    id: name,
                                    type: this.inferComponentType(name),
                                    value: cleanValue
                                });
                            }
                        });
                    }
                });

                // 添加常见的电源和地
                if (!components.find(c => c.type === 'vcc') && ascii.includes('VCC')) {
                    components.unshift({ id: 'VCC', type: 'vcc', value: '+5V' });
                }
                if (!components.find(c => c.type === 'ground') && ascii.includes('GND')) {
                    components.push({ id: 'GND', type: 'ground' });
                }

                return {
                    title: "解析的ASCII电路",
                    components: components,
                    connections: ['根据ASCII图解析的连接关系']
                };
            }

            inferComponentType(name) {
                const lowerName = name.toLowerCase();
                if (lowerName.match(/^r\\d+$/) || lowerName.includes('电阻')) return 'resistor';
                if (lowerName.match(/^c\\d+$/) || lowerName.includes('电容')) return 'capacitor';
                if (lowerName.match(/^l\\d+$/) || lowerName.includes('电感')) return 'inductor';
                if (lowerName.includes('led')) return 'led';
                if (lowerName.match(/^d\\d+$/)) return 'diode';
                if (lowerName.match(/^q\\d+$/)) return 'npn_transistor';
                if (lowerName.match(/^u\\d+$/) || lowerName.includes('opamp')) return 'opamp';
                return 'resistor';
            }

            showComponentsByCategory(category) {
                const components = [];
                this.symbols.forEach((symbol, id) => {
                    if (!category || symbol.category === category) {
                        components.push({
                            id: symbol.id.toUpperCase(),
                            type: id,
                            value: `示例${symbol.name}`
                        });
                    }
                });

                return {
                    title: category ? `${this.getCategoryName(category)}预览` : "所有组件预览",
                    components: components,
                    connections: ['组件库展示，无连接关系']
                };
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
            }
        }

        // 全局实例
        window.circuitRenderer = new MockCircuitRenderer();

        // 全局函数
        window.loadExampleCircuit = () => {
            showStatus('正在加载示例电路...', 'info');
            const circuit = circuitRenderer.generateExampleCircuit();
            circuitRenderer.renderCircuit(circuit, 'circuit1');
            showStatus('✅ 示例电路加载成功！展示了智能布局和组件分类。', 'success');
        };

        window.loadComplexCircuit = () => {
            showStatus('正在加载复杂电路...', 'info');
            const circuit = circuitRenderer.generateComplexCircuit();
            circuitRenderer.renderCircuit(circuit, 'circuit1');
            showStatus('✅ 复杂电路加载成功！展示了多种组件类型和智能排布。', 'success');
        };

        window.toggleTheme = () => {
            circuitRenderer.toggleTheme();
            showStatus(`🎨 主题已切换为: ${circuitRenderer.currentTheme}`, 'info');
            // 重新渲染当前电路
            if (document.getElementById('circuit1').innerHTML) {
                loadExampleCircuit();
            }
        };

        window.parseASCII = () => {
            const ascii = document.getElementById('asciiInput').value.trim();
            if (!ascii) {
                showStatus('⚠️ 请输入ASCII电路图！', 'error');
                return;
            }
            
            showStatus('正在解析ASCII电路图...', 'info');
            const circuit = circuitRenderer.parseASCIICircuit(ascii);
            circuitRenderer.renderCircuit(circuit, 'circuit2');
            showStatus(`✅ ASCII解析成功！识别到 ${circuit.components.length} 个组件。`, 'success');
        };

        window.clearASCII = () => {
            document.getElementById('asciiInput').value = '';
            document.getElementById('circuit2').innerHTML = '<p style="color: #999; text-align: center; padding: 50px;">输入ASCII电路图后点击解析按钮</p>';
            showStatus('✅ 已清空ASCII输入。', 'info');
        };

        window.showAllComponents = () => {
            showStatus('正在加载所有组件...', 'info');
            const circuit = circuitRenderer.showComponentsByCategory();
            circuitRenderer.renderCircuit(circuit, 'circuit3');
            showStatus(`✅ 组件库加载成功！共 ${circuit.components.length} 个组件。`, 'success');
        };

        window.showByCategory = (category) => {
            showStatus(`正在加载${circuitRenderer.getCategoryName(category)}...`, 'info');
            const circuit = circuitRenderer.showComponentsByCategory(category);
            circuitRenderer.renderCircuit(circuit, 'circuit3');
            showStatus(`✅ ${circuitRenderer.getCategoryName(category)}加载成功！`, 'success');
        };

        window.exportSVG = () => {
            showStatus('📥 SVG导出功能在实际应用中可用，当前为演示模式。', 'info');
        };

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type === 'error' ? 'error' : ''}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('🚀 CircuitsAI SVG电路图渲染引擎测试页面已就绪！', 'success');
            
            // 设置默认ASCII示例
            document.getElementById('asciiInput').value = `VCC ----+---- [R1(220Ω)] ----+---- [LED1(红色)] ---- GND
        |                            |
      [C1(100μF)]                 [R2(1kΩ)]
        |                            |
       GND                        [LED2(绿色)] ---- GND`;
            
            // 加载示例电路
            loadExampleCircuit();
            showAllComponents();
        });
    </script>
</body>
</html>