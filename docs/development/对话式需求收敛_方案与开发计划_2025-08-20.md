一、当前主要问题
- 对话记忆不稳定：跨实例/重启丢历史，影响多轮连续性与体验。
- 非流式回复：长输出期间无反馈，影响“讨论感”。
- 结构化结果不稳定：从自由文本抽取电路/元件/BOM 易错漏，BOM 可能为空。
- 多模型与提示词不统一：OpenAI/Claude/Gemini 行为不一致，系统提示与角色使用不规范。
- 容错与可观测性不足：无指数退避/超时取消/统一打点，请求难排障。
- 安全与前端渲染风险：日志可能泄漏敏感，前端直接注入 HTML 存在 XSS 风险。
- 架构约束：前端只能调用 Workers 域名，Pages 不承载 API；部署需走 GitHub CI。

二、目标体验（像“Vibe coding”一样边聊边成型）
- 聊天自然推进：从“你好”到“需求草图”到“草案/定稿”。
- 每次只问 1-2 个关键问题，提供快捷选项与可编辑默认值。
- 侧栏“需求卡片”实时更新，任何时刻可“出草案”或“继续细化”。
- 草案含电路、参数计算、BOM、连接表、注意事项、风险点与验收标准；用户点评后自动生成“变更单”，进入下一版。

三、解决方案概述
- 需求卡片侧栏（核心抓手）
  - 槽位模型：类型、输入电源、目标输出、负载、关键约束（成本/体积/效率/噪声/精度）、环境/安规、元件偏好/禁用、验收标准。
  - 每轮“微总结+下一步 1-2 问题”，持续更新；“出草案/继续细化”双按钮推进节奏。
- 流式对话（SSE）
  - Workers 提供 /api/ai/chat/stream，前端 EventSource 增量渲染与“停止生成”。
- 结构化优先，正则兜底
  - 各 provider 开启函数调用/JSON Schema 直接返回 circuit_data/bom_data；未命中再启用智能抽取。
- 稳定会话记忆
  - Durable Objects 存最近 N 轮对话与“需求卡片”；超长触发摘要；KV/D1 归档。
- 统一提示与适配
  - 固定 system 角色职责与输出格式；按 provider 最佳实践组织消息。
- 健壮性与治理
  - 重试/退避/超时、统一 requestId 与用量统计、日志去敏。
- 前端安全
  - 安全 Markdown 渲染与净化，设置面板隐藏敏感信息。

四、开发计划（里程碑）
- 里程碑 A：需求卡片侧栏（前端）
  - 侧栏组件 + 槽位模型 + 每轮微总结/动态提问 + “出草案”按钮。
  - 先基于现有回复做最小可用提取（前端临时），不改后端。
- 里程碑 B：流式 SSE + 前端流式渲染
  - 新增 /api/ai/chat/stream；EventSource 渲染与可中止。
- 里程碑 C：持久会话记忆
  - Durable Objects + 摘要 + KV/D1 归档。
- 里程碑 D：结构化输出改造
  - 函数调用/JSON Schema；抽取逻辑降级兜底。
- 里程碑 E：草案与定稿模板
  - 标准化输出版式与“变更单/风险清单/验收标准”。
- 里程碑 F：稳定性与安全
  - 退避/重试/超时、统一打点、日志去敏、前端安全渲染。
- 里程碑 G：交付与部署
  - GitHub CI/CD；前端仅调用 Workers API。

五、验收标准（量化）
- 3 轮内“需求卡片”完整度 ≥ 60%，10 轮内可出草案。
- 草案/BOM 非空率 ≥ 95%，关键计算覆盖率 ≥ 90%。
- 首 token 延迟 < 1s；会话跨实例记忆丢失率 < 1%。
- 错误自动恢复成功率 ≥ 90%，日志可用且无敏感泄漏。

六、近期优先事项
- A1：实现“需求卡片侧栏”原型并集成 ChatPanel。
- A2：引入逐轮“微总结+关键提问”与“一键出草案”。
- B1：完成 SSE 流式接口与前端增量渲染。
