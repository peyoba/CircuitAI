# API连接问题解决记录

**日期**: 2025-08-17  
**问题**: 前端API配置测试返回405错误  
**状态**: ✅ 已解决

## 问题现象

前端在测试API配置时出现以下错误：
```
POST https://circuitai.pages.dev/api/ai/test-config 405 (Method Not Allowed)
测试连接失败: SyntaxError: Failed to execute 'json' on 'Response': Unexpected end of JSON input
```

## 根本原因分析

### 核心问题
**前端错误地向Cloudflare Pages发送API请求，而不是向Cloudflare Workers发送**

### 技术原因
1. **Cloudflare Pages**：只能托管静态文件（HTML/CSS/JS），不支持API路由处理
2. **Cloudflare Workers**：专门用于处理API请求和服务端逻辑
3. **错误请求地址**：`https://circuitai.pages.dev/api/ai/test-config`
4. **正确请求地址**：`https://circuitai-api.peyoba660703.workers.dev/api/ai/test-config`

### 架构说明
```
前端应用 (Pages)     →     API服务 (Workers)
circuitai.pages.dev  →  circuitai-api.peyoba660703.workers.dev
    ↓                           ↓
   静态文件托管              API路由处理
```

## 问题定位过程

### 1. 错误日志分析
- 错误码：405 Method Not Allowed
- 请求地址：Pages域名而非Workers域名
- 响应内容：空白HTML页面而非JSON

### 2. 验证测试
```bash
# 测试Pages（错误） - 返回HTML页面
curl -X GET https://circuitai.pages.dev/api/health

# 测试Workers（正确） - 返回JSON数据
curl -X GET https://circuitai-api.peyoba660703.workers.dev/api/health
```

### 3. 代码检查
检查 `frontend/src/services/api.ts` 中的 `getApiBaseUrl()` 函数配置

## 解决方案

### 修复前端API配置
**文件**: `frontend/src/services/api.ts`

**修复前**（有问题的逻辑）：
```typescript
const getApiBaseUrl = () => {
  const isProduction = process.env.NODE_ENV === 'production';
  if (isProduction) {
    return 'https://circuitai-api.peyoba660703.workers.dev/api';
  }
  // ... 其他逻辑
}
```

**修复后**（明确的逻辑）：
```typescript
const getApiBaseUrl = () => {
  // 强制使用Workers API地址，无论什么环境
  if (typeof window !== 'undefined') {
    // 浏览器环境
    const hostname = window.location.hostname;
    
    // 本地开发环境
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return 'http://localhost:3003/api';
    }
    
    // 生产环境（包括Pages和其他域名）
    return 'https://circuitai-api.peyoba660703.workers.dev/api';
  }
  
  // 服务端渲染环境，默认使用Workers地址
  return 'https://circuitai-api.peyoba660703.workers.dev/api';
}
```

### 部署步骤
1. 修改前端API配置
2. 重新构建前端：`npm run build`
3. 部署到Pages：`npx wrangler pages deploy frontend/dist --project-name circuitai --branch main`

## 验证结果

### API测试成功
```bash
curl -X POST "https://circuitai-api.peyoba660703.workers.dev/api/ai/test-config" \
  -H "Content-Type: application/json" \
  -d '{"provider":"mock","apiKey":"test","apiUrl":"test","model":"test"}'

# 返回：{"success":true,"data":{"isValid":false,"provider":"mock","error":"..."}}
```

### 部署地址
- **前端**：https://circuitai.pages.dev
- **API**：https://circuitai-api.peyoba660703.workers.dev/api

## 经验教训

### 关键要点
1. **明确区分Pages和Workers的职责**
   - Pages：静态文件托管
   - Workers：API服务处理

2. **API请求必须发送到Workers域名**
   - ❌ `circuitai.pages.dev/api/*`
   - ✅ `circuitai-api.peyoba660703.workers.dev/api/*`

3. **环境判断要基于实际需求**
   - 不要依赖 `process.env.NODE_ENV`
   - 使用 `window.location.hostname` 判断运行环境

### 预防措施
1. **配置验证**：在开发时添加API地址日志输出
2. **文档更新**：明确标注API服务器地址
3. **测试覆盖**：确保所有环境下的API地址都正确

### 调试技巧
1. **检查Network面板**：确认实际请求URL
2. **使用curl测试**：验证API端点可达性
3. **分别测试**：Pages和Workers分开验证

## 相关文件

- `frontend/src/services/api.ts` - API配置文件
- `workers/src/index.ts` - Workers API实现
- `workers/wrangler.toml` - Workers部署配置

## 参考链接

- [Cloudflare Pages文档](https://developers.cloudflare.com/pages/)
- [Cloudflare Workers文档](https://developers.cloudflare.com/workers/)
- [项目部署指南](../CLOUDFLARE_DEPLOY.md)

---

**教训**：在微服务架构中，必须明确各服务的职责边界，确保请求发送到正确的服务端点。
