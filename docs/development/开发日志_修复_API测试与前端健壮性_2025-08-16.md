# 开发日志：修复 API 测试 405 与前端健壮性问题（2025-08-16）

本次变更目标：
- 解决 EnhancedAPISettings 测试接口在生产环境返回 405，且前端 `response.json()` 报错的问题。
- 提升前端 AutoComplete 的过滤函数健壮性，避免对 `undefined` 调用 `toLowerCase()`。

## 问题现象

- 控制台报错：
  - `POST https://circuitai.pages.dev/api/ai/test-config 405 (Method Not Allowed)`
  - `SyntaxError: Failed to execute 'json' on 'Response': Unexpected end of JSON input`
- 多处 `toLowerCase` 读取 undefined 的异常（可能来自扩展脚本，但前端也应防御）。

## 根因

- EnhancedAPISettings.tsx 和 APISettings.tsx 在“测试连接”时使用了相对路径 `fetch('/api/ai/test-config')`，线上 Pages 域名没有对应 Functions 路由，返回 405。
- 在非 2xx 且空响应体时直接 `response.json()` 会抛出 JSON 解析异常。
- AutoComplete 的 `filterOption` 未做空值保护。

## 已实施修复

1) 统一测试接口到 Workers（避免 Pages 405）
- 使用已封装的 `aiAPI.testApiConfig`（axios 基址根据环境自动指向 Workers：`https://circuitai-api.peyoba660703.workers.dev/api` 或本地 `http://localhost:3003/api`）。

变更文件：
- frontend/src/components/settings/EnhancedAPISettings.tsx
  - 增加：`import { aiAPI } from '../../services/api'`
  - 将原 `fetch('/api/ai/test-config')` 替换为 `aiAPI.testApiConfig(config)`
- frontend/src/components/settings/APISettings.tsx
  - 增加：`import { aiAPI } from '../../services/api'`
  - 将原 `fetch('/api/ai/test-config')` 替换为 `aiAPI.testApiConfig({...})`

2) 增强 AutoComplete 过滤函数健壮性
- EnhancedAPISettings.tsx 与 APISettings.tsx 的 `filterOption` 改为带空值保护：
  ```ts
  filterOption={(inputValue, option) => {
    const ov = typeof option?.value === 'string' ? option.value : String(option?.value ?? '')
    const iv = typeof inputValue === 'string' ? inputValue : String(inputValue ?? '')
    return ov.toLowerCase().includes(iv.toLowerCase())
  }}
  ```

3) 后端确认
- Workers 路由已存在 `POST /api/ai/test-config`（Hono 应用），CORS 已放行：
  - 允许来源：`https://circuitai.pages.dev`, `https://*.circuitai.pages.dev`, `http://localhost:3002`
  - 允许方法：`GET, POST, PUT, DELETE, OPTIONS`

## 验证步骤

本地（假设 Workers 在 3003，前端在 3002）：
1. 前端打开设置弹窗，填写 provider、apiKey、apiUrl、model。
2. 点击“测试连接”：
   - 预期调用 `http://localhost:3003/api/ai/test-config`。
   - 返回 `{ success: true, ... }` 时显示“连接成功”；失败时显示明确错误信息，不再有 JSON 解析异常。
3. 切换不同 provider，验证配置隔离与“高级选项”显示逻辑。

线上（Pages 域名）：
1. 点击“测试连接”：
   - 预期调用 `https://circuitai-api.peyoba660703.workers.dev/api/ai/test-config`。
   - 不再出现 405，也不会触发 JSON 解析异常。

补充：
- 控制台出现的 `content.js toLowerCase` 错误多为浏览器扩展注入脚本导致；前端已加防御，但建议在隐身模式禁用扩展进行对比验证。

## 影响范围

- 设置页面（APISettings 与 EnhancedAPISettings）的测试连接功能。
- 不涉及业务接口的入参/出参变更，其他模块不受影响。

## 后续建议

- 若需在 Pages 下直接提供 `/api/*`，可在 Cloudflare Pages Functions 中转发到 Workers，或在站点前加反向代理到 Workers。
- 统一在 `frontend/src/services/api.ts` 中扩展错误码与提示文案，减少重复处理。