import{r as p,j as s}from"./react-vendor-196c6b5f.js";import{u as W}from"./index-0ae8a5e9.js";import{a as X}from"./DesignPage-8f1067d5.js";import{f as c,B as k,S,h as g}from"./antd-forms-d358631e.js";import{M as Y,m as D}from"./antd-feedback-0ffbfebd.js";import{b as K,D as Z}from"./antd-layout-a3af7183.js";import{a6 as B,a7 as ee,a2 as se}from"./antd-others-e55acc79.js";import{J as oe,a8 as te,h as ae,P as le,f as re}from"./antd-icons-224a6422.js";import{C as ne}from"./antd-display-15ab9e7a.js";import"./vendor-46267779.js";import"./antd-core-b21eb6cb.js";import"./utils-b5ee139b.js";import"./adsense-7420754a.js";const be=({visible:I,onClose:w,onSave:J})=>{var U,H,T,$,V;const[i]=c.useForm(),{t:r}=W(),[z,P]=p.useState(!1),[x,f]=p.useState(null),[q,h]=p.useState(!1),[m,u]=p.useState([]),[n,G]=p.useState("openai"),[_,v]=p.useState(!1),y=p.useMemo(()=>[{value:"default",label:"智能AI助手 (推荐)",defaultUrl:"",keyExample:"无需配置",description:"系统内置AI，开箱即用，免费使用",models:["智能AI助手"],requestFormat:"openai",responseFormat:"openai",isDefault:!0},{value:"openai",label:"OpenAI GPT",defaultUrl:"https://api.openai.com/v1",keyExample:"sk-proj-...",description:"支持GPT-3.5/4等模型",models:["gpt-4","gpt-4-turbo","gpt-4o","gpt-3.5-turbo","gpt-4-turbo-preview"],requestFormat:"openai",responseFormat:"openai"},{value:"doubao",label:"Doubao (Volcengine Ark)",defaultUrl:"https://ark.cn-beijing.volces.com/api/v3",keyExample:"ark-xxx",description:"Doubao by Volcengine Ark (OpenAI-compatible chat/completions)",models:["doubao-seed-1-6-thinking-250715","doubao-pro-32k","doubao-lite"],requestFormat:"openai",responseFormat:"openai"},{value:"siliconflow",label:"SiliconFlow",defaultUrl:"https://api.siliconflow.cn/v1",keyExample:"sk-xxx",description:"SiliconFlow OpenAI-compatible endpoint",models:["deepseek-ai/DeepSeek-V2.5","Qwen/Qwen2.5-72B-Instruct"],requestFormat:"openai",responseFormat:"openai"},{value:"qwen",label:"Alibaba Tongyi Qwen",defaultUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",keyExample:"sk-xxx",description:"DashScope compatible-mode OpenAI APIs",models:["qwen-turbo","qwen-plus","qwen-long"],requestFormat:"openai",responseFormat:"openai"},{value:"perplexity",label:"Perplexity",defaultUrl:"https://api.perplexity.ai",keyExample:"pplx-xxx",description:"Perplexity OpenAI-compatible chat/completions",models:["pplx-70b-chat","pplx-7b-chat"],requestFormat:"openai",responseFormat:"openai"},{value:"claude",label:"Anthropic Claude",defaultUrl:"https://api.anthropic.com",keyExample:"sk-ant-...",description:"支持Claude-3等模型",models:["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],requestFormat:"claude",responseFormat:"claude"},{value:"gemini",label:"Google Gemini",defaultUrl:"https://generativelanguage.googleapis.com/v1beta",keyExample:"AIza...",description:"支持Gemini Pro等模型",models:["gemini-2.5-flash","gemini-pro","gemini-pro-vision","gemini-2.0-flash"],requestFormat:"custom",responseFormat:"custom"},{value:"custom",label:"自定义API",defaultUrl:"",keyExample:"your-api-key",description:"支持第三方API或自建服务",models:["你的模型名称","deepseek-chat","moonshot-v1-8k","qwen-turbo"],requestFormat:"openai",responseFormat:"openai"},{value:"mock",label:"模拟API (测试)",defaultUrl:"mock://localhost",keyExample:"test-key",description:"用于测试和演示，无需真实API密钥",models:["mock-gpt-4","mock-claude","mock-gemini"],requestFormat:"openai",responseFormat:"openai"},{value:"deepseek",label:"DeepSeek (国内)",defaultUrl:"https://api.deepseek.com",keyExample:"sk-xxx",description:"深度求索AI，国内可正常访问",models:["deepseek-chat","deepseek-coder"],requestFormat:"openai",responseFormat:"openai"},{value:"moonshot",label:"Moonshot AI (国内)",defaultUrl:"https://api.moonshot.cn",keyExample:"sk-xxx",description:"月之暗面AI，国内可正常访问",models:["moonshot-v1-8k","moonshot-v1-32k","moonshot-v1-128k"],requestFormat:"openai",responseFormat:"openai"}],[]),b=e=>`circuitsai_api_config_${e}`,C=p.useCallback((e,o=!1)=>{try{const t=localStorage.getItem(b(e));if(t){const l=JSON.parse(t);return o||console.log(`加载 ${e} 配置:`,l),l}const a=localStorage.getItem("circuitsai_api_config");if(a){const l=JSON.parse(a);if(l.provider===e)return localStorage.setItem(b(e),JSON.stringify(l)),o||console.log(`迁移旧配置到 ${e}:`,l),l}}catch(t){console.error(`Failed to load config for ${e}:`,t)}return o||console.log(`${e} 没有已保存的配置`),null},[]),A=(e,o)=>{try{localStorage.setItem(b(e),JSON.stringify(o)),localStorage.setItem("circuitsai_api_config",JSON.stringify(o)),console.log(`成功保存 ${e} 配置到存储:`,{key:b(e),config:o})}catch(t){console.error(`Failed to save config for ${e}:`,t)}};p.useEffect(()=>{if(I){const e=C(n,!0);if(e){if(i.setFieldsValue(e),v(!0),e.customHeaders){const o=Object.entries(e.customHeaders).map(([t,a])=>({key:t,value:a}));u(o)}else u([]);h(e.provider==="custom")}else{v(!1);const o=y.find(t=>t.value===n);o&&i.setFieldsValue({provider:n,apiUrl:o.defaultUrl,model:o.models[0],maxTokens:2e3,temperature:.7,requestFormat:o.requestFormat,responseFormat:o.responseFormat}),u([]),h(n==="custom")}f(null)}},[I,n,i,C,y]);const N=e=>{if(n!==e)try{const a=i.getFieldsValue();if(a.apiKey&&a.apiKey.trim()){const l={...a,provider:n,customHeaders:m.reduce((j,F)=>(F.key&&F.value&&(j[F.key]=F.value),j),{})};A(n,l),console.log(`已保存 ${n} 的配置:`,l)}}catch(a){console.warn("Failed to save current config:",a)}G(e);const o=C(e,!0),t=y.find(a=>a.value===e);if(o){if(v(!0),i.setFieldsValue(o),o.customHeaders){const a=Object.entries(o.customHeaders).map(([l,j])=>({key:l,value:j}));u(a)}else u([]);h(o.provider==="custom")}else t&&(v(!1),i.setFieldsValue({provider:e,apiUrl:t.defaultUrl,model:t.models[0],maxTokens:2e3,temperature:.7,requestFormat:t.requestFormat,responseFormat:t.responseFormat,apiKey:""}),u([]),h(e==="custom"));f(null)},R=()=>{u([...m,{key:"",value:""}])},M=e=>{const o=m.filter((t,a)=>a!==e);u(o)},E=(e,o,t)=>{const a=[...m];a[e][o]=t,u(a)},L=async()=>{try{const e=await i.validateFields();P(!0),f(null);const o={...e,customHeaders:m.reduce((a,l)=>(l.key&&l.value&&(a[l.key]=l.value),a),{})};console.log("发送测试请求:",o);const t=await X.testApiConfig(o);console.log("测试结果:",t),t&&t.success?f({success:!0,message:t.message||"API连接测试成功！"}):f({success:!1,message:t&&t.error||"API连接测试失败"})}catch(e){console.error("测试连接失败:",e),f({success:!1,message:"测试失败，请检查网络连接和配置"})}finally{P(!1)}},Q=async()=>{var e;try{const t={...await i.validateFields(),customHeaders:m.reduce((a,l)=>(l.key&&l.value&&(a[l.key]=l.value),a),{})};A(t.provider,t),v(!0),console.log("保存配置成功:",t),J(t),D.success(`${(e=d())==null?void 0:e.label} API配置已保存`),w()}catch(o){console.error("Save failed:",o),D.error("保存失败，请检查配置")}},O=()=>{try{const e=i.getFieldsValue();if(e.apiKey&&e.apiKey.trim()){const o={...e,customHeaders:m.reduce((t,a)=>(a.key&&a.value&&(t[a.key]=a.value),t),{})};A(o.provider,o)}}catch(e){console.warn("Failed to save config on close:",e)}w()},d=()=>y.find(e=>e.value===n);return s.jsx(Y,{title:s.jsxs(K,{children:[s.jsx(oe,{}),r("settings_title")]}),open:I,onCancel:O,width:700,footer:[s.jsx(k,{onClick:O,children:r("cancel")},"cancel"),s.jsx(k,{onClick:L,loading:z,children:r("test_connection")},"test"),s.jsx(k,{type:"primary",onClick:Q,children:r("save_config")},"save")],children:s.jsxs(c,{form:i,layout:"vertical",initialValues:{provider:"openai",apiUrl:"https://api.openai.com/v1",model:"gpt-3.5-turbo",maxTokens:2e3,temperature:.7,requestFormat:"openai",responseFormat:"openai"},children:[s.jsx(B,{message:r("settings_title"),description:"",type:"info",showIcon:!0,style:{marginBottom:16}}),s.jsx(c.Item,{label:r("provider_label"),name:"provider",rules:[{required:!0,message:"请选择AI提供商"}],children:s.jsx(S,{value:n,onChange:N,placeholder:"选择AI提供商",options:y.map(e=>({value:e.value,label:s.jsxs("div",{children:[s.jsx("div",{children:e.label}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:e.description})]})}))})}),s.jsx(c.Item,{label:r("api_key_label"),name:"apiKey",rules:[{required:!0,message:"请输入API密钥"},{min:10,message:"API密钥长度至少10位"}],children:s.jsx(g.Password,{placeholder:`请输入${((U=d())==null?void 0:U.label)||"API"}密钥`,iconRender:e=>e?s.jsx(te,{}):s.jsx(ae,{})})}),s.jsx(c.Item,{label:r("api_url_label"),name:"apiUrl",rules:[{required:!0,message:"请输入API地址"},{type:"url",message:"请输入有效的URL地址"}],children:s.jsx(g,{placeholder:"API地址"})}),s.jsx(c.Item,{label:r("model_name_label"),name:"model",rules:[{required:!0,message:"请输入模型名称"}],extra:"可以输入任意模型名称，支持自动补全",children:s.jsx(ee,{placeholder:"输入模型名称，如：gpt-4, claude-3-5-sonnet-20241022",allowClear:!0,options:((H=d())==null?void 0:H.models.map(e=>({value:e,label:e})))||[],filterOption:(e,o)=>{const t=typeof(o==null?void 0:o.value)=="string"?o.value:String((o==null?void 0:o.value)??""),a=typeof e=="string"?e:String(e??"");return t.toLowerCase().includes(a.toLowerCase())}})}),s.jsx(Z,{children:s.jsxs(K,{children:[r("advanced_options"),s.jsx(se,{checked:q,onChange:h})]})}),q&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:{display:"flex",gap:"16px"},children:[s.jsx(c.Item,{label:"最大令牌数",name:"maxTokens",style:{flex:1},children:s.jsx(g,{type:"number",placeholder:"2000"})}),s.jsx(c.Item,{label:"温度参数",name:"temperature",style:{flex:1},children:s.jsx(g,{type:"number",step:"0.1",placeholder:"0.7"})})]}),s.jsxs("div",{style:{display:"flex",gap:"16px"},children:[s.jsx(c.Item,{label:r("request_format"),name:"requestFormat",style:{flex:1},children:s.jsx(S,{options:[{value:"openai",label:"OpenAI格式"},{value:"claude",label:"Claude格式"},{value:"custom",label:"自定义格式"}]})}),s.jsx(c.Item,{label:r("response_format"),name:"responseFormat",style:{flex:1},children:s.jsx(S,{options:[{value:"openai",label:"OpenAI格式"},{value:"claude",label:"Claude格式"},{value:"custom",label:"自定义格式"}]})})]}),s.jsxs("div",{children:[s.jsxs("div",{style:{marginBottom:"8px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsx("span",{children:r("custom_headers")}),s.jsx(k,{icon:s.jsx(le,{}),onClick:R,size:"small",children:r("add")})]}),m.map((e,o)=>s.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px"},children:[s.jsx(g,{placeholder:"Header名称",value:e.key,onChange:t=>E(o,"key",t.target.value),style:{flex:1}}),s.jsx(g,{placeholder:"Header值",value:e.value,onChange:t=>E(o,"value",t.target.value),style:{flex:1}}),s.jsx(k,{onClick:()=>M(o),size:"small",children:r("delete")})]},o))]})]}),d()&&s.jsxs(ne,{size:"small",style:{backgroundColor:"#f9f9f9",marginTop:16},children:[s.jsx("h4",{children:"配置说明："}),s.jsxs("p",{children:[s.jsx("strong",{children:"提供商："}),(T=d())==null?void 0:T.label]}),s.jsxs("p",{children:[s.jsx("strong",{children:"密钥格式："}),($=d())==null?void 0:$.keyExample]}),s.jsxs("p",{children:[s.jsx("strong",{children:"说明："}),(V=d())==null?void 0:V.description]}),s.jsxs("p",{children:[s.jsx("strong",{children:"配置状态："}),s.jsx("span",{style:{color:_?"#52c41a":"#ff4d4f"},children:_?"已配置":"未配置"})]})]}),x&&s.jsx(B,{message:x.success?"连接成功":"连接失败",description:x.message,type:x.success?"success":"error",showIcon:!0,icon:x.success?s.jsx(re,{}):void 0,style:{marginTop:16}})]})})};export{be as default};
//# sourceMappingURL=EnhancedAPISettings-99daf6c3.js.map
