var yt=Object.defineProperty;var ft=(r,s,i)=>s in r?yt(r,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[s]=i;var ke=(r,s,i)=>(ft(r,typeof s!="symbol"?s+"":s,i),i);import{j as e,r as y,u as jt}from"./react-vendor-196c6b5f.js";import{u as ne,_ as bt}from"./index-0ae8a5e9.js";import{a as Qe}from"./utils-b5ee139b.js";import{m as S,S as ge,M as Be}from"./antd-feedback-0ffbfebd.js";import{o as ee,_ as qe,$ as wt,a0 as ye,T as Ze,E as W,a1 as vt,a2 as Ne,a3 as Ct,a4 as kt,a5 as Nt}from"./antd-others-e55acc79.js";import{y as _t,z as St,A as xe,s as re,G as It,J as At,K as Tt,N as $t,Z as Xe,O as Ye,V as Pt,W as Se,X as Et,Y as Ot,_ as Lt,$ as Mt,a0 as We,a1 as Ae,a2 as He,a3 as zt,a4 as Rt,S as Ft,p as et,r as Vt,a5 as Gt,a6 as Ut,a7 as Bt}from"./antd-icons-224a6422.js";import{f as J,B as N,h as q,S as Te,j as De}from"./antd-forms-d358631e.js";import{b as X,D as me,L as Ie,R as qt,C as Ke}from"./antd-layout-a3af7183.js";import{L as Z,A as _e,C as te,T as Ht}from"./antd-display-15ab9e7a.js";import{A as Dt,a as Kt}from"./adsense-7420754a.js";const tt=()=>{if(typeof window<"u"){const r=window.location.hostname;return r==="localhost"||r==="127.0.0.1"?"http://localhost:3003/api":"https://circuitai-api.peyoba660703.workers.dev/api"}return"https://circuitai-api.peyoba660703.workers.dev/api"},he=Qe.create({baseURL:tt(),timeout:6e4,headers:{"Content-Type":"application/json"}}),$e=Qe.create({baseURL:tt(),timeout:12e4,headers:{"Content-Type":"application/json"}});$e.interceptors.request.use(r=>(r.metadata={startTime:new Date().getTime()},r),r=>Promise.reject(r));$e.interceptors.response.use(r=>{var t;const s=new Date().getTime(),i=s-(((t=r.config.metadata)==null?void 0:t.startTime)||s);return console.log(`AI API请求耗时: ${i}ms`),r},r=>{const{response:s}=r;if(s){const{status:i,data:t}=s;console.error(`AI API错误 [${i}]:`,(t==null?void 0:t.error)||s.statusText)}else r.code==="ECONNABORTED"?console.error("AI API请求超时"):console.error("AI API网络错误:",r.message);return Promise.reject(r)});he.interceptors.request.use(r=>(r.metadata={startTime:new Date().getTime()},r),r=>Promise.reject(r));he.interceptors.response.use(r=>{var t;const s=new Date().getTime(),i=s-(((t=r.config.metadata)==null?void 0:t.startTime)||s);return console.log(`API请求耗时: ${i}ms`),r},r=>{const{response:s}=r;if(s){const{status:i,data:t}=s;switch(i){case 400:S.error(t.error||"请求参数错误");break;case 401:S.error("未授权访问，请先登录");break;case 403:S.error("访问被拒绝");break;case 404:S.error("请求的资源不存在");break;case 429:S.error("请求过于频繁，请稍后再试");break;case 500:S.error(t.error||"服务器内部错误");break;default:S.error(t.error||`请求失败 (${i})`)}}else r.code==="ECONNABORTED"?S.error("请求超时，请检查网络连接"):S.error("网络错误，请检查网络连接");return Promise.reject(r)});const Jt={async chat(r){var s,i,t,a,m,u,o;try{return(await $e.post("/ai/chat",{message:r.message,conversation_id:r.conversationId,provider:r.provider||"openai",apiConfig:r.apiConfig})).data}catch(l){const h=l;if(h.code==="ECONNABORTED")throw new Error("AI响应超时，请稍后重试或检查网络连接");if(((s=h.response)==null?void 0:s.status)===500){const I=((t=(i=h.response)==null?void 0:i.data)==null?void 0:t.error)||"服务器内部错误";throw new Error(`AI服务暂时不可用：${I}`)}else{if(((a=h.response)==null?void 0:a.status)===429)throw new Error("请求过于频繁，请稍等片刻后再试");if((m=h.response)!=null&&m.status&&h.response.status>=400&&h.response.status<500){const I=((o=(u=h.response)==null?void 0:u.data)==null?void 0:o.error)||"请求参数错误";throw new Error(`${I}`)}else throw new Error("网络连接失败，请检查网络或稍后重试")}}},async getModels(){return(await he.get("/ai/models")).data.available_models},async testApiConfig(r){try{return(await he.post("/ai/test-config",r)).data}catch{return{success:!1,error:"测试失败，请检查配置"}}},async getProviders(){try{return(await he.get("/ai/providers")).data.data||[]}catch{return[]}},async validateApiKey(r,s){try{return(await this.testApiConfig({provider:r,apiKey:s,apiUrl:"",model:"test"})).success}catch{return!1}}},Qt=({model:r,isConfigured:s})=>{const{t:i}=ne();return s?e.jsx(ee,{title:i("settings_title"),children:e.jsx(qe,{status:"success",text:e.jsxs("span",{children:[e.jsx(_t,{style:{marginRight:4}}),`${r} (Configured)`]})})}):e.jsx(ee,{title:i("api_settings"),children:e.jsx(qe,{status:"warning",text:e.jsxs("span",{children:[e.jsx(St,{style:{marginRight:4}}),`${r} (Mock)`]})})})},Zt=[{label:"成本",value:"成本"},{label:"体积",value:"体积"},{label:"效率",value:"效率"},{label:"噪声",value:"噪声"},{label:"精度",value:"精度"}],Xt=({visible:r,value:s,onChange:i,onClose:t,onGenerateDraft:a,risks:m=[],changes:u=[]})=>{const[o]=J.useForm(),{t:l}=ne(),h=(g,C)=>{i(C)},I=y.useMemo(()=>{const g=[];return s.type||g.push("你要做哪类电路？例如：电源稳压/LED驱动/放大器/音频功放"),s.inputPower||g.push("输入电源是多少？例如：5V/12V/电池3.7V（范围也可以）"),s.outputTarget||g.push("目标输出是什么？例如：恒压5V/恒流10mA/增益20dB"),s.load||g.push("负载是什么？例如：单颗LED/8Ω喇叭/传感器输入，典型参数是多少？"),(!s.priorities||s.priorities.length===0)&&g.push("以下哪个更重要：成本/体积/效率/噪声/精度（选1-2项）"),s.environment||g.push("工作环境与安规要求？例如：室内/户外/EMC/是否电池设备"),s.preferences||g.push("元件偏好或禁用？例如：贴片0805/禁用某型号/偏好常见货源"),s.acceptanceCriteria||g.push("验收标准是？例如：纹波≤X、效率≥Y、成本≤Z"),g.slice(0,5)},[s]);return e.jsxs(wt,{title:l("req_card_title"),placement:"right",width:420,onClose:t,open:r,destroyOnClose:!0,extra:e.jsxs(X,{children:[e.jsx(N,{onClick:()=>o.resetFields(),children:l("reset")}),e.jsx(N,{type:"primary",onClick:a,children:l("generate_draft")})]}),children:[e.jsxs(J,{form:o,layout:"vertical",initialValues:s,onValuesChange:h,children:[e.jsx(J.Item,{label:l("field_circuit_type"),name:"type",children:e.jsx(q,{placeholder:"例如：LED驱动 / 电源稳压 / 放大器"})}),e.jsx(J.Item,{label:l("field_input_power"),name:"inputPower",children:e.jsx(q,{placeholder:"例如：5V / 12V / 电池3.7V"})}),e.jsx(J.Item,{label:l("field_output_target"),name:"outputTarget",children:e.jsx(q,{placeholder:"例如：恒流10mA / 恒压5V / 增益20dB"})}),e.jsx(J.Item,{label:l("field_load"),name:"load",children:e.jsx(q,{placeholder:"例如：单颗LED / 扬声器8Ω / 传感器输入"})}),e.jsx(J.Item,{label:l("field_priorities"),name:"priorities",children:e.jsx(Te,{mode:"multiple",options:Zt,placeholder:"选择最重要的1-2项"})}),e.jsx(J.Item,{label:l("field_environment"),name:"environment",children:e.jsx(q.TextArea,{rows:2,placeholder:"例如：室温/户外/EMC要求/电池设备"})}),e.jsx(J.Item,{label:l("field_preferences"),name:"preferences",children:e.jsx(q.TextArea,{rows:2,placeholder:"例如：优先贴片0805、禁用某型号等"})}),e.jsx(me,{}),e.jsx(J.Item,{label:l("field_acceptance_criteria"),name:"acceptanceCriteria",children:e.jsx(q.TextArea,{rows:3,placeholder:"例如：纹波≤X，效率≥Y，成本≤Z"})})]}),e.jsx(me,{}),e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsxs("span",{children:[l("confirmed_items"),"："]}),e.jsx(X,{size:[4,8],wrap:!0,children:Object.entries(s).filter(([,g])=>Array.isArray(g)?g.length>0:!!g).map(([g])=>e.jsx(ye,{color:"blue",children:g},g))})]}),e.jsx(me,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-700 mb-2",children:l("suggestions_title")}),e.jsx(Z,{size:"small",dataSource:I,locale:{emptyText:"看起来信息比较完整，可以直接生成草案。"},renderItem:g=>e.jsxs(Z.Item,{style:{padding:"4px 0"},children:["• ",g]})})]}),e.jsx(me,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-700 mb-2",children:l("risks_title")}),e.jsx(Z,{size:"small",dataSource:m,locale:{emptyText:"暂无显著风险。"},renderItem:g=>e.jsxs(Z.Item,{style:{padding:"4px 0"},children:["• ",g]})})]}),e.jsx(me,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-700 mb-2",children:l("changes_title")}),e.jsx(Z,{size:"small",dataSource:u,locale:{emptyText:"暂无变更记录。"},renderItem:g=>e.jsxs(Z.Item,{style:{padding:"4px 0"},children:["• ",g]})})]})]})},Je={provider:"default",apiKey:"",apiUrl:"",model:"智能AI助手",maxTokens:4e3,temperature:.7,displayName:"智能AI助手",description:"系统内置AI，开箱即用",isDefault:!0},Yt=()=>{try{const r=localStorage.getItem("circuitsai_api_config");if(r){const s=JSON.parse(r);return s.provider==="default"||!s.apiKey?Je:s}}catch(r){console.warn("Failed to load user API config, using default:",r)}return Je},Wt=r=>r.provider==="default"?{provider:"default",model:"default",apiKey:"",apiUrl:"",displayName:r.displayName,description:r.description,maxTokens:r.maxTokens,temperature:r.temperature,requestFormat:r.requestFormat,responseFormat:r.responseFormat,customHeaders:r.customHeaders}:r,es=r=>{try{localStorage.setItem("circuitsai_api_config",JSON.stringify(r))}catch(s){console.error("Failed to save API config:",s)}},ts=y.lazy(()=>bt(()=>import("./EnhancedAPISettings-99daf6c3.js"),["assets/EnhancedAPISettings-99daf6c3.js","assets/react-vendor-196c6b5f.js","assets/vendor-46267779.js","assets/index-0ae8a5e9.js","assets/antd-layout-a3af7183.js","assets/antd-core-b21eb6cb.js","assets/antd-others-e55acc79.js","assets/antd-feedback-0ffbfebd.js","assets/antd-icons-224a6422.js","assets/antd-forms-d358631e.js","assets/index-2abee980.css","assets/antd-display-15ab9e7a.js","assets/utils-b5ee139b.js","assets/adsense-7420754a.js"])),{TextArea:ss}=q,is=({onCircuitGenerated:r,onBomGenerated:s,onChatHistory:i,initialMessages:t})=>{var ze;const{t:a}=ne(),[m,u]=y.useState([{id:"1",role:"assistant",content:"",timestamp:new Date}]);y.useEffect(()=>{u([{id:"1",role:"assistant",content:a("assistant_welcome"),timestamp:new Date}])},[a]);const[o,l]=y.useState(""),[h,I]=y.useState(!1),[g,C]=y.useState("deepseek"),[z,G]=y.useState(!1),[w,j]=y.useState(!1),[k,T]=y.useState(!1),[O,$]=y.useState(0),[P,H]=y.useState([]),[L,f]=y.useState(0),[c,d]=y.useState([]);y.useEffect(()=>{d([a("quick_action_5v_regulator"),a("quick_action_led_blink"),a("quick_action_opamp_amplifier"),a("quick_action_audio_amp")])},[a]);const[p,v]=y.useState(null),E=y.useRef(null),pe=y.useRef(null),Pe=y.useRef(`conv_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),[st,fe]=y.useState(!1),[D,ue]=y.useState({type:"",inputPower:"",outputTarget:"",load:"",priorities:[],environment:"",preferences:"",acceptanceCriteria:""}),[je,be]=y.useState([]),[we,ve]=y.useState([]),Ee=[{value:"openai",label:"OpenAI GPT",icon:"🤖"},{value:"claude",label:"Claude",icon:"🧠"},{value:"gemini",label:"Google Gemini",icon:"⭐"},{value:"doubao",label:"Doubao",icon:"🐯"},{value:"siliconflow",label:"SiliconFlow",icon:"⚡"},{value:"qwen",label:"Qwen",icon:"🌿"},{value:"perplexity",label:"Perplexity",icon:"🔎"},{value:"custom",label:"Custom API",icon:"⚙️"}],it=()=>{var n;(n=E.current)==null||n.scrollIntoView({behavior:"smooth"})};y.useEffect(()=>{it()},[m]),y.useEffect(()=>{try{const n=localStorage.getItem("circuitsai_requirements"),x=localStorage.getItem("circuitsai_requirements_risks"),b=localStorage.getItem("circuitsai_requirements_changes");n&&ue(JSON.parse(n)),x&&be(JSON.parse(x)),b&&ve(JSON.parse(b))}catch(n){console.warn("Failed to load requirements:",n)}},[]),y.useEffect(()=>{const n=Yt();console.log("加载的API配置:",n),v(n),j(!0),C(n.provider)},[]),y.useEffect(()=>{t&&t.length>0&&u(t)},[t]),y.useEffect(()=>{i&&m.length>1&&i(m)},[m,i]),y.useEffect(()=>{try{localStorage.setItem("circuitsai_requirements",JSON.stringify(D))}catch(n){console.warn("Failed to save requirements:",n)}},[D]),y.useEffect(()=>{try{localStorage.setItem("circuitsai_requirements_risks",JSON.stringify(je))}catch(n){console.warn("Failed to save risks:",n)}},[je]),y.useEffect(()=>{try{localStorage.setItem("circuitsai_requirements_changes",JSON.stringify(we))}catch(n){console.warn("Failed to save changes:",n)}},[we]);const Oe=n=>{const x=n.toLowerCase(),b={};/稳压|恒压/.test(n)?b.type="电源稳压":/led/.test(x)||/发光|灯/.test(n)?b.type="LED驱动":/放大|运放/.test(n)?b.type="放大器":/音频|功放/.test(n)&&(b.type="音频功放");const _=n.match(/(输入|供电|电源|VCC)[^\d]{0,6}(\d+(?:\.\d+)?\s*(?:V|伏))/i),F=n.match(/(\d+(?:\.\d+)?\s*(?:V|伏))(?:\s*-\s*(\d+(?:\.\d+)?\s*(?:V|伏)))?/i);_?b.inputPower=_[2]:F&&(b.inputPower=F[0]);const M=n.match(/恒流\s*(\d+(?:\.\d+)?\s*mA)/i),B=n.match(/恒压\s*(\d+(?:\.\d+)?\s*V)/i),se=n.match(/增益\s*(\d+(?:\.\d+)?\s*dB)/i);M?b.outputTarget=`恒流 ${M[1]}`:B?b.outputTarget=`恒压 ${B[1]}`:se&&(b.outputTarget=`增益 ${se[1]}`),/LED\s*\d*/i.test(n)||/发光二极管|指示灯/.test(n)?b.load="LED":/扬声器|喇叭|8Ω|8 Ohm/i.test(n)?b.load="扬声器/8Ω":/电机|马达/.test(n)?b.load="电机":/传感器/.test(n)&&(b.load="传感器");const K=[];/成本/.test(n)&&K.push("成本"),/体积/.test(n)&&K.push("体积"),/效率/.test(n)&&K.push("效率"),/噪声/.test(n)&&K.push("噪声"),/精度/.test(n)&&K.push("精度"),K.length&&(b.priorities=Array.from(new Set(K)));const oe=n.match(/##\s*验收标准([\s\S]*?)(?=##|$)/i);if(oe)b.acceptanceCriteria=oe[1].trim().slice(0,300);else{const Y=[],ae=n.match(/效率\s*[≥>=]\s*([\d.]+%)/),le=n.match(/纹波\s*[≤<=]\s*([\d.]+\s*(?:mV|V))/),ce=n.match(/成本\s*[≤<=]\s*([\d.]+\s*元?)/);ae&&Y.push(`效率≥${ae[1]}`),le&&Y.push(`纹波≤${le[1]}`),ce&&Y.push(`成本≤${ce[1]}`),Y.length&&(b.acceptanceCriteria=Y.join("，"))}return b},Le=()=>{const n=m.filter(_=>_.role==="user").slice(-5);if(n.length===0)return;const x=n.map(_=>_.content).join(`
`),b=Oe(x);ue(_=>({..._,...b}))},rt=n=>{const x=Oe(n),b={...D},_=[];if(["type","inputPower","outputTarget","load","acceptanceCriteria"].forEach(M=>{const B=x[M];if(B&&b[M]!==B){const se=b[M]||"未设置";_.push(`${M}: ${se} -> ${B}`),b[M]=B}}),x.priorities&&x.priorities.length){const M=Array.from(new Set([...b.priorities||[],...x.priorities]));M.length!==(b.priorities||[]).length&&_.push(`priorities -> ${M.join("、")}`),b.priorities=M}_.length&&(ue(b),ve(M=>[...M,..._]));const F=[];b.inputPower||F.push("输入电源未明确，可能影响器件耐压与效率选型"),b.outputTarget||F.push("输出目标未明确，无法进行参数计算与校核"),b.load||F.push("负载特性未明确，驱动/功率预算存在不确定性"),(!b.priorities||b.priorities.length===0)&&F.push("未设置优先级，难以在方案间做取舍"),be(F)},nt=n=>{const x=[],b=D;["type","inputPower","outputTarget","load","environment","preferences","acceptanceCriteria"].forEach(_=>{if(b[_]!==n[_]){const F=b[_]||"未设置",M=n[_]||"未设置";x.push(`${_}: ${F} -> ${M}`)}}),JSON.stringify(b.priorities)!==JSON.stringify(n.priorities)&&x.push(`priorities: ${(b.priorities||[]).join("、")||"未设置"} -> ${(n.priorities||[]).join("、")||"未设置"}`),x.length&&ve(_=>[..._,...x]),ue(n)},ot=n=>{var M;if(!n||typeof n!="string")return{thinking:[],mainContent:n||""};const x=n.match(/<thinking>([\s\S]*?)<\/thinking>/i);if(!x)return{thinking:[],mainContent:n};const _=(((M=x[1])==null?void 0:M.trim())||"").split(/\d+\.\s*/).filter(B=>B.trim()).map(B=>B.trim()),F=n.replace(/<thinking>[\s\S]*?<\/thinking>/i,"").trim();return{thinking:_,mainContent:F}},at=async n=>{H(n),f(0);for(let x=0;x<n.length;x++)f(x),$((x+1)/n.length*100),await new Promise(b=>setTimeout(b,800+Math.random()*400))},Ce=async()=>{var x,b,_,F,M,B,se,K,oe,Y,ae,le,ce,Re,Fe,Ve,Ge,Ue;if(!o.trim()||h)return;const n={id:Date.now().toString(),role:"user",content:o.trim(),timestamp:new Date};u(U=>[...U,n]),l(""),I(!0);try{console.log("发送到后端的配置:",{provider:g,apiConfig:p||void 0});const U=p?Wt(p):void 0,V=U?{provider:U.provider,model:U.model,apiKey:U.apiKey,apiUrl:U.apiUrl,temperature:U.temperature,maxTokens:U.maxTokens,requestFormat:U.requestFormat,responseFormat:U.responseFormat,customHeaders:U.customHeaders}:void 0,R=await Jt.chat({message:n.content,conversationId:Pe.current,provider:(V==null?void 0:V.provider)||g,apiConfig:V||void 0});(x=R.data)!=null&&x.conversationId&&(Pe.current=R.data.conversationId);const de=((b=R==null?void 0:R.data)==null?void 0:b.response)||"",{thinking:A,mainContent:ut}=ot(de);A.length>0&&await at(A),$(0),H([]),f(0),T(!0);const xt={id:(Date.now()+1).toString(),role:"assistant",content:ut||de,timestamp:new Date};setTimeout(()=>{u(gt=>[...gt,xt]),T(!1),rt(de)},500),console.log("检查响应数据:",{hasCircuitData:!!((_=R.data)!=null&&_.circuit_data),hasBomData:!!((F=R.data)!=null&&F.bom_data),circuitComponents:((se=(B=(M=R.data)==null?void 0:M.circuit_data)==null?void 0:B.components)==null?void 0:se.length)||0,bomItems:((Y=(oe=(K=R.data)==null?void 0:K.bom_data)==null?void 0:oe.items)==null?void 0:Y.length)||0}),(ae=R.data)!=null&&ae.circuit_data&&r&&(console.log("传递电路数据到父组件:",R.data.circuit_data),r(R.data.circuit_data)),(le=R.data)!=null&&le.bom_data&&s&&(console.log("传递BOM数据到父组件:",R.data.bom_data),s(R.data.bom_data))}catch(U){console.error("发送消息失败:",U),$(0),H([]),f(0),T(!1);let V="抱歉，我现在无法回复。",R=!1;if(U instanceof Error){const A=U.message;A.includes("AI响应超时")?V="⏱️ AI响应超时，可能是网络较慢或AI服务繁忙，请稍后重试。":A.includes("AI服务暂时不可用")?(V="🔧 AI服务暂时不可用，请检查API配置或稍后重试。",R=!0):A.includes("请求过于频繁")?V="⏳ 请求过于频繁，请等待片刻后再试。":A.includes("网络连接失败")?V="🌐 网络连接失败，请检查网络连接后重试。":V=`❌ ${A}`}else{const A=U;((ce=A==null?void 0:A.response)==null?void 0:ce.status)===401?(V="❌ API密钥无效或未配置，请在设置中检查您的AI服务配置。",R=!0):((Re=A==null?void 0:A.response)==null?void 0:Re.status)===429?V="⏳ API请求频率过高，请稍等片刻后再试。":((Fe=A==null?void 0:A.response)==null?void 0:Fe.status)===503?(V="🔌 AI服务连接失败，请检查网络连接或API地址配置。",R=!0):(A==null?void 0:A.code)==="ECONNABORTED"?V="⏱️ 请求超时，AI服务响应时间过长，请稍后重试。":(Ve=A==null?void 0:A.message)!=null&&Ve.includes("Network Error")?V="🌐 网络连接错误，请检查您的网络连接。":(Ue=(Ge=A==null?void 0:A.response)==null?void 0:Ge.data)!=null&&Ue.error&&(V=`❌ ${A.response.data.error}`)}const de={id:(Date.now()+1).toString(),role:"assistant",content:V,timestamp:new Date};u(A=>[...A,de]),S.error(V),R&&!w&&setTimeout(()=>{G(!0)},1e3)}finally{I(!1),$(0),H([]),f(0)}},lt=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),Ce())},ct=()=>{u([{id:"1",role:"assistant",content:"对话已清空。请告诉我您想要设计什么样的电路？",timestamp:new Date}])},dt=()=>{const n=m.map(F=>`${F.role==="user"?"用户":"AI助手"} (${F.timestamp.toLocaleString()}):
${F.content}

`).join(""),x=new Blob([n],{type:"text/plain;charset=utf-8"}),b=URL.createObjectURL(x),_=document.createElement("a");_.href=b,_.download=`CircuitsAI_Chat_${new Date().toISOString().split("T")[0]}.txt`,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(b)},mt=n=>{console.log("API配置已更新:",n);const x={...n,displayName:n.provider==="default"?"智能AI助手":`${n.provider} - ${n.model}`,description:n.provider==="default"?"系统内置AI，无需配置即可使用":"用户自定义配置",isDefault:n.provider==="default",maxTokens:n.maxTokens||4e3,temperature:n.temperature||.7};es(x),v(x),C(n.provider),j(!0),S.success("API配置已更新")},ht=n=>n.replace(/```([\s\S]*?)```/g,'<pre style="背景: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;"><code>$1</code></pre>').replace(/`([^`]+)`/g,'<code style="background: #f0f0f0; padding: 2px 4px; border-radius: 2px;">$1</code>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br/>"),pt=n=>{const x=[];return x.push("请根据以下“需求卡片”生成电路草案，包含：电路说明、ASCII电路图、元件列表、连接关系、BOM、关键参数计算与注意事项。"),x.push("如果信息缺失，请用合理的行业默认值，并在“风险与待确认”中标注。"),x.push(""),x.push("【需求卡片】"),x.push(`类型: ${n.type||"未指定"}`),x.push(`输入电源: ${n.inputPower||"未指定"}`),x.push(`目标输出: ${n.outputTarget||"未指定"}`),x.push(`负载特性: ${n.load||"未指定"}`),x.push(`优先级: ${(n.priorities||[]).join("、")||"未指定"}`),x.push(`环境/安规: ${n.environment||"未指定"}`),x.push(`元件偏好/禁用: ${n.preferences||"未指定"}`),x.push(`验收标准: ${n.acceptanceCriteria||"未指定"}`),x.push(""),x.push("请按标准格式输出各部分，并确保BOM非空。"),x.join(`
`)},Me=async()=>{if(Le(),fe(!0),!Object.values(D).some(_=>Array.isArray(_)?_.length>0:!!_)){S.info("已从最近对话尝试提取信息，请补充关键项后再生成草案。");return}const x=[];D.inputPower||x.push("输入电源未明确"),D.outputTarget||x.push("输出目标未明确"),D.load||x.push("负载特性未明确"),D.acceptanceCriteria||x.push("未设置验收标准"),be(x);const b=pt(D);l(b),await new Promise(_=>setTimeout(_)),Ce()};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"p-3 border-b bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(xe,{className:"text-blue-500 text-lg flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-800 truncate",children:a("ai_assistant")}),e.jsx(Qt,{model:((ze=Ee.find(n=>n.value===g))==null?void 0:ze.label)||g,isConfigured:w})]})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(Te,{value:g,onChange:C,size:"small",style:{minWidth:160},options:Ee.map(n=>({value:n.value,label:`${n.icon} ${n.label}`}))})})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-1",children:[e.jsx(N,{icon:e.jsx(re,{}),onClick:dt,size:"small",type:"text",title:a("export_chat")}),e.jsx(N,{icon:e.jsx(It,{}),onClick:ct,size:"small",type:"text",title:a("clear_chat")}),e.jsx(N,{icon:e.jsx(At,{}),onClick:()=>G(!0),size:"small",type:"text",title:a("api_settings")}),e.jsx(N,{onClick:()=>{Le(),fe(!0)},size:"small",type:"primary",children:a("requirements_card")}),e.jsx(N,{onClick:Me,size:"small",children:a("generate_draft")})]})]}),e.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-4",style:{maxHeight:"calc(100vh - 200px)"},children:[m.map(n=>e.jsxs("div",{className:`flex gap-3 ${n.role==="user"?"flex-row-reverse":""}`,children:[e.jsx(_e,{icon:n.role==="user"?e.jsx(Tt,{}):e.jsx(xe,{}),className:n.role==="user"?"bg-blue-500":"bg-green-500"}),e.jsxs("div",{className:`max-w-[80%] ${n.role==="user"?"text-right":""}`,children:[e.jsx("div",{className:`p-3 rounded-lg ${n.role==="user"?"bg-blue-500 text-white":"bg-gray-100 text-gray-800"}`,dangerouslySetInnerHTML:{__html:ht(n.content)}}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:n.timestamp.toLocaleTimeString()})]})]},n.id)),h&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx(_e,{icon:e.jsx(xe,{}),className:"bg-green-500"}),e.jsx("div",{className:"bg-gray-100 p-3 rounded-lg min-w-[200px] max-w-[80%]",children:P.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800 mb-2",children:"🤔 AI思考过程："}),P.map((n,x)=>e.jsxs("div",{className:`flex items-start gap-2 p-2 rounded ${x<L?"bg-green-50 border border-green-200":x===L?"bg-blue-50 border border-blue-200":"bg-gray-50 opacity-50"}`,children:[e.jsx("div",{className:`flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${x<L?"bg-green-500 text-white":x===L?"bg-blue-500 text-white animate-pulse":"bg-gray-300 text-gray-500"}`,children:x<L?"✓":x+1}),e.jsxs("div",{className:`text-sm flex-1 ${x<=L?"text-gray-700":"text-gray-400"}`,children:[n,x===L&&e.jsx(ge,{size:"small",className:"ml-2"})]})]},x)),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500",style:{width:`${O}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center",children:["思考中... ",Math.round(O),"%"]})]})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{size:"small"}),e.jsx("span",{className:"text-sm text-gray-700",children:"正在分析您的需求..."})]})})]}),k&&e.jsxs("div",{className:"flex gap-3",children:[e.jsx(_e,{icon:e.jsx(xe,{}),className:"bg-green-500"}),e.jsxs("div",{className:"bg-gray-100 p-3 rounded-lg flex items-center gap-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm text-gray-600",children:a("typing_hint")})]})]}),e.jsx("div",{ref:E})]}),m.length<=1&&e.jsxs("div",{className:"border-t p-4 bg-white",children:[e.jsxs("div",{className:"text-sm text-gray-600 mb-3",children:["💡 ",a("quick_start"),"："]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:c.map((n,x)=>e.jsx(N,{size:"small",type:"dashed",onClick:()=>{var b;l(n),(b=pe.current)==null||b.focus()},className:"text-blue-600 border-blue-300 hover:border-blue-500 hover:text-blue-700",children:n},x))})]}),e.jsxs("div",{className:"border-t p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ss,{ref:pe,value:o,onChange:n=>l(n.target.value),onKeyPress:lt,placeholder:a("input_placeholder"),rows:3,disabled:h,className:"flex-1"}),e.jsx(N,{type:"primary",icon:e.jsx($t,{}),onClick:Ce,disabled:!o.trim()||h,className:"h-20",children:a("send")})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:"按 Enter 发送，Shift + Enter 换行"})]}),z&&e.jsx(y.Suspense,{fallback:e.jsx(ge,{size:"large"}),children:e.jsx(ts,{visible:z,onClose:()=>G(!1),onSave:mt})}),e.jsx(Xt,{visible:st,value:D,onChange:nt,onClose:()=>fe(!1),onGenerateDraft:Me,risks:je,changes:we})]})},rs=({circuitData:r,loading:s=!1})=>{const{t:i}=ne(),[t,a]=y.useState("ascii"),[m,u]=y.useState(12),[o,l]=y.useState(!0),[h,I]=y.useState(!1),g=async j=>{try{await navigator.clipboard.writeText(j),S.success(i("copied"))}catch{S.error(i("copy_failed"))}},C=(j,k)=>{const T=new Blob([j],{type:"text/plain;charset=utf-8"}),O=URL.createObjectURL(T),$=document.createElement("a");$.href=O,$.download=k,document.body.appendChild($),$.click(),document.body.removeChild($),URL.revokeObjectURL(O)},z=()=>{var j;return r!=null&&r.ascii?e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(N,{icon:e.jsx(Xe,{}),onClick:()=>u(Math.max(8,m-1)),size:"small"}),e.jsxs("span",{className:"text-sm text-gray-600 min-w-[40px] text-center",children:[m,"px"]}),e.jsx(N,{icon:e.jsx(Ye,{}),onClick:()=>u(Math.min(20,m+1)),size:"small"}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-2"}),e.jsx(N,{onClick:()=>I(!h),size:"small",type:h?"primary":"default",children:i("line_numbers")}),e.jsx(N,{onClick:()=>l(!o),size:"small",type:o?"primary":"default",children:o?"🌙":"☀️"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{icon:e.jsx(Pt,{}),onClick:()=>g(r.ascii||""),size:"small",children:i("copy")}),e.jsx(N,{icon:e.jsx(re,{}),onClick:()=>C(r.ascii||"","circuit.txt"),size:"small",children:i("download")})]})]}),e.jsx("div",{className:`p-4 rounded-lg overflow-auto font-mono relative ${o?"bg-gray-900 text-green-400 border border-gray-700":"bg-white text-gray-800 border border-gray-300"}`,style:{maxHeight:"400px"},children:h?e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`pr-4 text-right select-none ${o?"text-gray-500":"text-gray-400"} border-r ${o?"border-gray-700":"border-gray-300"} mr-4`,children:(j=r.ascii)==null?void 0:j.split(`
`).map((k,T)=>e.jsx("div",{style:{fontSize:`${m}px`,lineHeight:1.2},children:T+1},T))}),e.jsx("div",{className:"flex-1",children:e.jsx("pre",{className:"whitespace-pre",style:{fontSize:`${m}px`,lineHeight:1.2,margin:0},children:r.ascii})})]}):e.jsx("pre",{className:"whitespace-pre",style:{fontSize:`${m}px`,lineHeight:1.2,margin:0},children:r.ascii})}),r.description&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-800 mb-2",children:i("description")}),e.jsx("p",{className:"text-sm text-blue-700",children:r.description})]})]}):e.jsx(W,{description:i("no_schematic"),image:W.PRESENTED_IMAGE_SIMPLE,children:e.jsx("p",{className:"text-gray-500",children:i("schematic_hint")})})},G=()=>{if(!(r!=null&&r.components)||r.components.length===0)return e.jsx(W,{description:i("no_component_info"),image:W.PRESENTED_IMAGE_SIMPLE});const j=k=>r!=null&&r.properties?r.properties.filter(T=>{const O=T.name.toLowerCase(),$=k.toLowerCase();return O.includes($)||O.includes("电阻")&&$.includes("resistor")||O.includes("电容")&&$.includes("capacitor")||O.includes("电压")||O.includes("电流")||O.includes("功率")}):[];return e.jsxs("div",{className:"space-y-4",children:[r.components.map((k,T)=>{const O=j(k.type);return e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50 transition-colors",children:[e.jsx("div",{className:"flex justify-between items-start mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:k.name}),k.reference&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 text-sm font-mono rounded",children:k.reference})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 gap-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[i("type"),":"]}),e.jsx("span",{className:"font-mono text-gray-800",children:k.type})]}),k.value&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[i("table_value"),":"]}),e.jsx("span",{className:"font-mono text-blue-600 font-semibold",children:k.value})]}),k.reference&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[i("table_ref"),":"]}),e.jsx("span",{className:"font-mono text-gray-800",children:k.reference})]}),k.package&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[i("table_package"),":"]}),e.jsx("span",{className:"font-mono text-gray-800",children:k.package})]}),O.slice(0,4).map(($,P)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[$.name,":"]}),e.jsxs("span",{className:"font-mono text-green-600",children:[$.value,$.unit]})]},P))]})]})}),k.description&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsx("p",{className:"text-sm text-gray-600",children:k.description})})]},T)}),(r==null?void 0:r.properties)&&r.properties.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 bg-blue-50",children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-800 mb-3",children:i("circuit_properties")}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:r.properties.map((k,T)=>e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm text-blue-600 font-medium",children:k.name}),e.jsxs("span",{className:"text-lg font-mono text-blue-800",children:[k.value,k.unit]}),k.description&&e.jsx("span",{className:"text-xs text-blue-500",children:k.description})]},T))})]})]})},w=()=>!(r!=null&&r.connections)||r.connections.length===0?e.jsx(W,{description:i("no_connection_info"),image:W.PRESENTED_IMAGE_SIMPLE}):e.jsx("div",{className:"space-y-2",children:r.connections.map((j,k)=>e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium",children:j.from.component}),j.from.pin&&e.jsxs("span",{className:"text-xs text-blue-600",children:["(",j.from.pin,")"]}),e.jsx("span",{className:"text-gray-400 font-bold",children:"→"}),e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded text-sm font-medium",children:j.to.component}),j.to.pin&&e.jsxs("span",{className:"text-xs text-green-600",children:["(",j.to.pin,")"]})]}),j.label&&e.jsx("div",{className:"text-xs text-gray-600",children:j.label}),j.description&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:j.description})]},k))});return s?e.jsx(te,{className:"h-full",children:e.jsxs("div",{className:"flex items-center justify-center h-96",children:[e.jsx(ge,{size:"large"}),e.jsx("span",{className:"ml-3",children:"Generating circuit..."})]})}):e.jsx(te,{title:i("circuit_design"),className:"h-full",styles:{body:{padding:0,height:"calc(100% - 57px)"}},children:e.jsx(Ze,{activeKey:t,onChange:a,className:"h-full",tabBarStyle:{paddingLeft:16,paddingRight:16,marginBottom:0},items:[{key:"ascii",label:i("schematic_tab"),children:e.jsx("div",{className:"h-full overflow-auto p-4",children:z()})},{key:"components",label:i("components_tab"),children:e.jsx("div",{className:"h-full overflow-auto p-4",children:G()})},{key:"connections",label:i("connections_tab"),children:e.jsx("div",{className:"h-full overflow-auto p-4",children:w()})}]})})};class ns{constructor(){ke(this,"symbols",new Map);this.initializeSymbols()}initializeSymbols(){this.addSymbol({id:"resistor",name:"电阻",type:"resistor",category:"passive",width:60,height:20,svgPath:`
        <rect x="10" y="5" width="40" height="10" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="10" x2="10" y2="10" stroke="currentColor" stroke-width="2"/>
        <line x1="50" y1="10" x2="60" y2="10" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"1",name:"1",position:{x:0,y:10},direction:"bidirectional",type:"signal"},{id:"2",name:"2",position:{x:60,y:10},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"capacitor",name:"电容",type:"capacitor",category:"passive",width:60,height:30,svgPath:`
        <line x1="25" y1="5" x2="25" y2="25" stroke="currentColor" stroke-width="3"/>
        <line x1="35" y1="5" x2="35" y2="25" stroke="currentColor" stroke-width="3"/>
        <line x1="0" y1="15" x2="25" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="15" x2="60" y2="15" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"1",name:"+",position:{x:0,y:15},direction:"bidirectional",type:"signal"},{id:"2",name:"-",position:{x:60,y:15},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"inductor",name:"电感",type:"inductor",category:"passive",width:60,height:20,svgPath:`
        <path d="M 10 10 Q 15 0 20 10 Q 25 20 30 10 Q 35 0 40 10 Q 45 20 50 10" 
              fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="10" x2="10" y2="10" stroke="currentColor" stroke-width="2"/>
        <line x1="50" y1="10" x2="60" y2="10" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"1",name:"1",position:{x:0,y:10},direction:"bidirectional",type:"signal"},{id:"2",name:"2",position:{x:60,y:10},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"diode",name:"二极管",type:"diode",category:"semiconductor",width:60,height:30,svgPath:`
        <polygon points="30,5 45,15 30,25" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="5" x2="45" y2="25" stroke="currentColor" stroke-width="3"/>
        <line x1="0" y1="15" x2="30" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="15" x2="60" y2="15" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"A",name:"A",position:{x:0,y:15},direction:"input",type:"signal"},{id:"K",name:"K",position:{x:60,y:15},direction:"output",type:"signal"}]}),this.addSymbol({id:"led",name:"LED",type:"led",category:"semiconductor",width:60,height:40,svgPath:`
        <polygon points="30,10 45,20 30,30" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="10" x2="45" y2="30" stroke="currentColor" stroke-width="3"/>
        <line x1="0" y1="20" x2="30" y2="20" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="20" x2="60" y2="20" stroke="currentColor" stroke-width="2"/>
        <!-- 发光箭头 -->
        <path d="M 48 8 L 52 4 M 48 8 L 44 8 M 48 8 L 48 4" 
              stroke="currentColor" stroke-width="1" fill="none"/>
        <path d="M 52 12 L 56 8 M 52 12 L 48 12 M 52 12 L 52 8" 
              stroke="currentColor" stroke-width="1" fill="none"/>
      `,pins:[{id:"A",name:"A",position:{x:0,y:20},direction:"input",type:"signal"},{id:"K",name:"K",position:{x:60,y:20},direction:"output",type:"signal"}]}),this.addSymbol({id:"npn_transistor",name:"NPN晶体管",type:"transistor",category:"semiconductor",width:60,height:60,svgPath:`
        <circle cx="30" cy="30" r="20" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="20" y1="30" x2="40" y2="30" stroke="currentColor" stroke-width="3"/>
        <line x1="35" y1="20" x2="35" y2="40" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="30" x2="20" y2="30" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="20" x2="55" y2="5" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="40" x2="55" y2="55" stroke="currentColor" stroke-width="2"/>
        <line x1="55" y1="5" x2="60" y2="0" stroke="currentColor" stroke-width="2"/>
        <line x1="55" y1="55" x2="60" y2="60" stroke="currentColor" stroke-width="2"/>
        <!-- 发射极箭头 -->
        <polygon points="50,50 55,45 55,55" fill="currentColor"/>
      `,pins:[{id:"B",name:"B",position:{x:0,y:30},direction:"input",type:"signal"},{id:"C",name:"C",position:{x:60,y:0},direction:"output",type:"signal"},{id:"E",name:"E",position:{x:60,y:60},direction:"output",type:"signal"}]}),this.addSymbol({id:"opamp",name:"运算放大器",type:"opamp",category:"analog_ic",width:80,height:60,svgPath:`
        <polygon points="10,10 70,30 10,50" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="20" x2="10" y2="20" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="40" x2="10" y2="40" stroke="currentColor" stroke-width="2"/>
        <line x1="70" y1="30" x2="80" y2="30" stroke="currentColor" stroke-width="2"/>
        <text x="15" y="25" font-family="Arial" font-size="12" fill="currentColor">+</text>
        <text x="15" y="45" font-family="Arial" font-size="12" fill="currentColor">-</text>
      `,pins:[{id:"IN+",name:"+",position:{x:0,y:20},direction:"input",type:"signal"},{id:"IN-",name:"-",position:{x:0,y:40},direction:"input",type:"signal"},{id:"OUT",name:"OUT",position:{x:80,y:30},direction:"output",type:"signal"}]}),this.addSymbol({id:"ground",name:"地",type:"ground",category:"power",width:30,height:30,svgPath:`
        <line x1="15" y1="0" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="5" y1="15" x2="25" y2="15" stroke="currentColor" stroke-width="3"/>
        <line x1="8" y1="20" x2="22" y2="20" stroke="currentColor" stroke-width="2"/>
        <line x1="11" y1="25" x2="19" y2="25" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"GND",name:"GND",position:{x:15,y:0},direction:"input",type:"ground"}]}),this.addSymbol({id:"vcc",name:"电源",type:"power",category:"power",width:30,height:30,svgPath:`
        <line x1="15" y1="15" x2="15" y2="30" stroke="currentColor" stroke-width="2"/>
        <line x1="5" y1="15" x2="25" y2="15" stroke="currentColor" stroke-width="3"/>
        <line x1="10" y1="10" x2="20" y2="10" stroke="currentColor" stroke-width="2"/>
        <line x1="12" y1="5" x2="18" y2="5" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"VCC",name:"VCC",position:{x:15,y:30},direction:"output",type:"power"}]}),this.addSymbol({id:"voltage_source",name:"电压源",type:"voltage_source",category:"power",width:60,height:60,svgPath:`
        <circle cx="30" cy="30" r="25" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="30" x2="5" y2="30" stroke="currentColor" stroke-width="2"/>
        <line x1="55" y1="30" x2="60" y2="30" stroke="currentColor" stroke-width="2"/>
        <line x1="20" y1="30" x2="40" y2="30" stroke="currentColor" stroke-width="2"/>
        <line x1="30" y1="20" x2="30" y2="25" stroke="currentColor" stroke-width="2"/>
        <text x="18" y="25" font-family="Arial" font-size="16" fill="currentColor">+</text>
        <text x="35" y="40" font-family="Arial" font-size="16" fill="currentColor">-</text>
      `,pins:[{id:"+",name:"+",position:{x:0,y:30},direction:"output",type:"power"},{id:"-",name:"-",position:{x:60,y:30},direction:"input",type:"power"}]}),this.addSymbol({id:"switch",name:"开关",type:"switch",category:"passive",width:60,height:30,svgPath:`
        <line x1="0" y1="15" x2="20" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="40" y1="15" x2="60" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="20" y1="15" x2="35" y2="5" stroke="currentColor" stroke-width="2"/>
        <circle cx="20" cy="15" r="2" fill="currentColor"/>
        <circle cx="40" cy="15" r="2" fill="currentColor"/>
      `,pins:[{id:"1",name:"1",position:{x:0,y:15},direction:"bidirectional",type:"signal"},{id:"2",name:"2",position:{x:60,y:15},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"fuse",name:"保险丝",type:"fuse",category:"passive",width:60,height:20,svgPath:`
        <rect x="15" y="5" width="30" height="10" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="10" x2="15" y2="10" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="10" x2="60" y2="10" stroke="currentColor" stroke-width="2"/>
        <line x1="20" y1="10" x2="40" y2="10" stroke="currentColor" stroke-width="3"/>
      `,pins:[{id:"1",name:"1",position:{x:0,y:10},direction:"bidirectional",type:"signal"},{id:"2",name:"2",position:{x:60,y:10},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"crystal",name:"晶振",type:"crystal",category:"passive",width:60,height:40,svgPath:`
        <rect x="20" y="10" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="15" y1="8" x2="15" y2="32" stroke="currentColor" stroke-width="3"/>
        <line x1="45" y1="8" x2="45" y2="32" stroke="currentColor" stroke-width="3"/>
        <line x1="0" y1="20" x2="15" y2="20" stroke="currentColor" stroke-width="2"/>
        <line x1="45" y1="20" x2="60" y2="20" stroke="currentColor" stroke-width="2"/>
      `,pins:[{id:"1",name:"1",position:{x:0,y:20},direction:"bidirectional",type:"signal"},{id:"2",name:"2",position:{x:60,y:20},direction:"bidirectional",type:"signal"}]}),this.addSymbol({id:"mosfet_n",name:"N-MOSFET",type:"mosfet",category:"semiconductor",width:80,height:80,svgPath:`
        <line x1="30" y1="10" x2="30" y2="70" stroke="currentColor" stroke-width="3"/>
        <line x1="35" y1="15" x2="35" y2="25" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="35" x2="35" y2="45" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="55" x2="35" y2="65" stroke="currentColor" stroke-width="2"/>
        <line x1="0" y1="40" x2="30" y2="40" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="20" x2="60" y2="5" stroke="currentColor" stroke-width="2"/>
        <line x1="35" y1="60" x2="60" y2="75" stroke="currentColor" stroke-width="2"/>
        <line x1="60" y1="5" x2="65" y2="0" stroke="currentColor" stroke-width="2"/>
        <line x1="60" y1="75" x2="65" y2="80" stroke="currentColor" stroke-width="2"/>
        <!-- 箭头指向源极 -->
        <polygon points="40,58 45,53 45,63" fill="currentColor"/>
      `,pins:[{id:"G",name:"G",position:{x:0,y:40},direction:"input",type:"signal"},{id:"D",name:"D",position:{x:65,y:0},direction:"output",type:"signal"},{id:"S",name:"S",position:{x:65,y:80},direction:"output",type:"signal"}]})}addSymbol(s){this.symbols.set(s.id,s)}getSymbol(s){return this.symbols.get(s)}getAllSymbols(){return Array.from(this.symbols.values())}getSymbolsByCategory(s){return Array.from(this.symbols.values()).filter(i=>i.category===s)}parseASCIICircuit(s){if(!s)return this.getExampleCircuit();const i=[],t=[],a=s.split(`
`);let m=0;return a.forEach((u,o)=>{const l=u.match(/\[([^\]]+)\]/g);l&&l.forEach((h,I)=>{const g=h.replace(/[[\]]/g,""),C=this.inferComponentType(g),z=this.getSymbol(C)||this.getSymbol("resistor"),w=50+u.indexOf(h)*8+I*120,j=50+o*30;i.push({id:g,type:C,position:{x:w,y:j},rotation:0,properties:{reference:g,value:this.extractComponentValue(g,s)},symbol:z})})}),a.forEach((u,o)=>{const l=u.match(/[-+|]{3,}/g);l&&l.forEach(()=>{const I=u.length*8,g=50+o*30;t.push({id:`wire${m++}`,points:[{x:50,y:g},{x:I,y:g}],color:"#22c55e"})})}),this.connectAdjacentComponents(i,t),{components:i,wires:t,bounds:{width:Math.max(600,Math.max(...i.map(u=>u.position.x))+200),height:Math.max(400,Math.max(...i.map(u=>u.position.y))+200)}}}getExampleCircuit(){return{components:[{id:"VCC",type:"vcc",position:{x:100,y:50},rotation:0,properties:{value:"+5V"},symbol:this.getSymbol("vcc")},{id:"R1",type:"resistor",position:{x:100,y:120},rotation:90,properties:{value:"220Ω"},symbol:this.getSymbol("resistor")},{id:"LED1",type:"led",position:{x:100,y:220},rotation:90,properties:{color:"red"},symbol:this.getSymbol("led")},{id:"GND",type:"ground",position:{x:100,y:300},rotation:0,properties:{},symbol:this.getSymbol("ground")}],wires:[{id:"wire1",points:[{x:115,y:80},{x:115,y:120}],color:"#22c55e"},{id:"wire2",points:[{x:115,y:180},{x:115,y:220}],color:"#22c55e"},{id:"wire3",points:[{x:115,y:280},{x:115,y:300}],color:"#22c55e"}],bounds:{width:300,height:400}}}inferComponentType(s){const i=s.toLowerCase();return i.match(/^r\d+$/)||i.includes("电阻")?"resistor":i.match(/^c\d+$/)||i.includes("电容")?"capacitor":i.match(/^l\d+$/)||i.includes("电感")?"inductor":i.match(/^d\d+$/)||i.includes("二极管")?"diode":i.includes("led")||i.includes("发光")?"led":i.match(/^q\d+$/)||i.includes("晶体管")?"npn_transistor":i.includes("运放")||i.includes("opamp")?"opamp":i.includes("开关")||i.includes("switch")?"switch":i.includes("vcc")||i.includes("电源")?"vcc":i.includes("gnd")||i.includes("地")?"ground":i.includes("晶振")||i.includes("crystal")?"crystal":"resistor"}extractComponentValue(s,i){const t=i.split(`
`);for(const a of t)if(a.includes(s)){const m=[/(\d+(?:\.\d+)?)\s*(Ω|ohm|欧)/i,/(\d+(?:\.\d+)?)\s*(μF|nF|pF|uF)/i,/(\d+(?:\.\d+)?)\s*(mH|μH|H)/i,/(\d+(?:\.\d+)?)\s*(V|伏)/i,/(\d+(?:\.\d+)?)\s*(mA|A|安)/i];for(const o of m){const l=a.match(o);if(l)return l[1]+l[2]}const u=a.match(/\(([^)]+)\)/);if(u)return u[1]}return""}connectAdjacentComponents(s,i){for(let t=0;t<s.length-1;t++){const a=s[t],m=s[t+1];if(Math.sqrt(Math.pow(m.position.x-a.position.x,2)+Math.pow(m.position.y-a.position.y,2))<150){const o={id:`auto_wire_${t}`,points:[{x:a.position.x+a.symbol.width/2,y:a.position.y+a.symbol.height/2},{x:m.position.x+m.symbol.width/2,y:m.position.y+m.symbol.height/2}],color:"#22c55e"};i.push(o)}}}renderToSVG(s,i){const{bounds:t}=s,{gridSize:a,showGrid:m,theme:u,scale:o}=i;let l=`<svg width="${t.width*o}" height="${t.height*o}" 
                    viewBox="0 0 ${t.width} ${t.height}" 
                    xmlns="http://www.w3.org/2000/svg" 
                    style="background: ${u==="dark"?"#1a1a1a":"#ffffff"}; color: ${u==="dark"?"#ffffff":"#000000"};">`;m&&(l+=this.renderGrid(t,a,u));for(const h of s.wires)l+=this.renderWire(h,u);for(const h of s.components)l+=this.renderComponent(h,i);return l+="</svg>",l}renderGrid(s,i,t){let a='<defs><pattern id="grid" width="'+i+'" height="'+i+'" patternUnits="userSpaceOnUse">';return a+='<path d="M '+i+" 0 L 0 0 0 "+i+'" fill="none" stroke="'+(t==="dark"?"#333":"#ddd")+'" stroke-width="1"/></pattern></defs>',a+='<rect width="100%" height="100%" fill="url(#grid)"/>',a}renderWire(s,i){if(s.points.length<2)return"";let t=`<path d="M ${s.points[0].x} ${s.points[0].y}`;for(let a=1;a<s.points.length;a++)t+=` L ${s.points[a].x} ${s.points[a].y}`;return t+=`" stroke="${s.color||(i==="dark"?"#4ade80":"#22c55e")}" stroke-width="2" fill="none"/>`,t}renderComponent(s,i){const{position:t,rotation:a,symbol:m,properties:u}=s,{showLabels:o}=i;let l=`<g transform="translate(${t.x}, ${t.y}) rotate(${a})">`;return l+=m.svgPath,o&&(l+=`<text x="${m.width/2}" y="${m.height+15}" 
                    text-anchor="middle" font-family="Arial" font-size="12" fill="currentColor">
                ${s.id}
              </text>`,u.value&&(l+=`<text x="${m.width/2}" y="${m.height+30}" 
                      text-anchor="middle" font-family="Arial" font-size="10" fill="currentColor">
                  ${u.value}
                </text>`)),l+="</g>",l}autoLayout(s){if(s.length===0)return{components:[],wires:[],bounds:{width:400,height:300}};const i=s.filter(w=>w.symbol.category==="power"),t=s.filter(w=>w.symbol.category==="passive"),a=s.filter(w=>w.symbol.category==="semiconductor"),m=s.filter(w=>w.symbol.category==="analog_ic"),u=s.filter(w=>!["power","passive","semiconductor","analog_ic"].includes(w.symbol.category)),o=[],l=[];let h=80;const I=80,g=120,C=100;if(i.length>0){let w=I;i.forEach(j=>{j.position={x:w,y:h},o.push(j),w+=g}),h+=C}if(m.length>0){let w=I+g;m.forEach(j=>{j.position={x:w,y:h},o.push(j),w+=g*1.5}),h+=C*1.2}if(a.length>0){let w=I,j=0;const k=3;a.forEach(T=>{T.position={x:w,y:h},o.push(T),j++,j>=k?(h+=C,w=I,j=0):w+=g}),j>0&&(h+=C)}if(t.length>0){let w=I,j=0;const k=4;t.forEach(T=>{T.position={x:w,y:h},o.push(T),j++,j>=k?(h+=C*.8,w=I,j=0):w+=g*.8}),j>0&&(h+=C*.8)}if(u.length>0){let w=I;u.forEach(j=>{j.position={x:w,y:h},o.push(j),w+=g}),h+=C}this.createSmartConnections(o,l);const z=Math.max(...o.map(w=>w.position.x+w.symbol.width)),G=Math.max(...o.map(w=>w.position.y+w.symbol.height));return{components:o,wires:l,bounds:{width:Math.max(600,z+100),height:Math.max(400,G+100)}}}createSmartConnections(s,i){const t=s.filter(o=>o.type==="vcc"),a=s.filter(o=>o.type==="ground"),m=s.filter(o=>o.type==="resistor"),u=s.filter(o=>o.type==="led");if(t.length>0&&m.length>0){const o=t[0],l=m[0];i.push({id:"power_to_resistor",points:[{x:o.position.x+o.symbol.width/2,y:o.position.y+o.symbol.height},{x:l.position.x+l.symbol.width/2,y:l.position.y}],color:"#ef4444"})}if(m.length>0&&u.length>0){const o=m[0],l=u[0];i.push({id:"resistor_to_led",points:[{x:o.position.x+o.symbol.width/2,y:o.position.y+o.symbol.height},{x:l.position.x+l.symbol.width/2,y:l.position.y}],color:"#22c55e"})}if(u.length>0&&a.length>0){const o=u[0],l=a[0];i.push({id:"led_to_ground",points:[{x:o.position.x+o.symbol.width/2,y:o.position.y+o.symbol.height},{x:l.position.x+l.symbol.width/2,y:l.position.y}],color:"#000000"})}}exportToPNG(s,i,t){return new Promise((a,m)=>{const u=document.createElement("canvas"),o=u.getContext("2d");if(!o){m(new Error("无法获取Canvas上下文"));return}u.width=i,u.height=t;const l=new Image;l.onload=()=>{o.drawImage(l,0,0),u.toBlob(h=>{h?a(h):m(new Error("PNG导出失败"))},"image/png")},l.onerror=()=>m(new Error("SVG加载失败")),l.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(s)))})}}const Q=new ns,os=({circuitData:r,loading:s=!1,editable:i=!1})=>{const{t}=ne(),a=y.useRef(null),[m,u]=y.useState(1),[o,l]=y.useState(null),[h,I]=y.useState({gridSize:20,showGrid:!0,theme:"light",scale:1,showLabels:!0,showPinNumbers:!1}),[g,C]=y.useState(!1);y.useEffect(()=>{if(r!=null&&r.ascii){const c=Q.parseASCIICircuit(r.ascii);l(c)}else if(r!=null&&r.components&&r.components.length>0){const c=r.components.map((p,v)=>({id:p.reference||`COMP${v+1}`,type:z(p.type||p.name||""),position:{x:100+v%3*120,y:100+Math.floor(v/3)*80},rotation:0,properties:{value:p.value||"",reference:p.reference||`COMP${v+1}`},symbol:Q.getSymbol(z(p.type||p.name||""))||Q.getSymbol("resistor")})),d=Q.autoLayout(c);l(d)}else{const c=Q.parseASCIICircuit();l(c)}},[r]);const z=c=>{const d=c.toLowerCase();return d.includes("电阻")||d.includes("resistor")||d.match(/^r\d+$/)?"resistor":d.includes("电容")||d.includes("capacitor")||d.match(/^c\d+$/)?"capacitor":d.includes("电感")||d.includes("inductor")||d.match(/^l\d+$/)?"inductor":d.includes("二极管")||d.includes("diode")||d.match(/^d\d+$/)?"diode":d.includes("led")||d.includes("发光二极管")?"led":d.includes("晶体管")||d.includes("transistor")||d.match(/^q\d+$/)?"npn_transistor":d.includes("mosfet")||d.includes("场效应管")||d.includes("mos")?"mosfet_n":d.includes("运放")||d.includes("opamp")||d.includes("op-amp")||d.includes("lm358")||d.includes("lm741")?"opamp":d.includes("开关")||d.includes("switch")||d.includes("按键")?"switch":d.includes("保险丝")||d.includes("fuse")||d.includes("熔断器")?"fuse":d.includes("晶振")||d.includes("crystal")||d.includes("振荡器")?"crystal":d.includes("电压源")||d.includes("voltage_source")||d.includes("电池")?"voltage_source":d.includes("电源")||d.includes("vcc")||d.includes("power")||d.includes("+5v")||d.includes("+3.3v")?"vcc":d.includes("地")||d.includes("gnd")||d.includes("ground")?"ground":d.includes("ic")||d.includes("芯片")||d.match(/^u\d+$/)?"opamp":"resistor"},G=()=>{const c=Math.min(m*1.2,3);u(c),I(d=>({...d,scale:c}))},w=()=>{const c=Math.max(m/1.2,.3);u(c),I(d=>({...d,scale:c}))},j=c=>{I(d=>({...d,theme:c}))},k=c=>{I(d=>({...d,showGrid:c}))},T=c=>{I(d=>({...d,gridSize:c}))},O=c=>{I(d=>({...d,showLabels:c}))},$=c=>{I(d=>({...d,showPinNumbers:c}))},P=()=>{if(!o){S.warning("No schematic to export");return}const c=Q.renderToSVG(o,h),d=new Blob([c],{type:"image/svg+xml"}),p=URL.createObjectURL(d),v=document.createElement("a");v.href=p,v.download=`circuit_${Date.now()}.svg`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(p),S.success("SVG exported")},H=async()=>{if(!o){S.warning("No schematic to export");return}try{const c=Q.renderToSVG(o,h),d=await Q.exportToPNG(c,o.bounds.width*h.scale,o.bounds.height*h.scale),p=URL.createObjectURL(d),v=document.createElement("a");v.href=p,v.download=`circuit_${Date.now()}.png`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(p),S.success("PNG exported")}catch(c){S.error("PNG export failed: "+c.message)}},L=()=>{var c,d;!g&&a.current?((d=(c=a.current).requestFullscreen)==null||d.call(c),C(!0)):document.fullscreenElement&&(document.exitFullscreen(),C(!1))},f=()=>{if(!o)return null;const c=Q.renderToSVG(o,h);return e.jsx("div",{dangerouslySetInnerHTML:{__html:c},style:{transform:`scale(${m})`,transformOrigin:"top left",transition:"transform 0.3s ease"}})};return e.jsx(te,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"text-purple-600"}),e.jsx("span",{children:t("tab_visual")}),o&&e.jsxs("span",{className:"text-sm text-gray-500",children:["(",o.components.length," ",t("components"),")"]})]}),className:"h-full",extra:e.jsxs(X,{children:[e.jsx(Te,{value:h.theme,onChange:j,size:"small",style:{width:80},options:[{value:"light",label:t("theme_light")},{value:"dark",label:t("theme_dark")}]}),e.jsx(ee,{title:t("toggle_grid"),children:e.jsx(N,{icon:h.showGrid?e.jsx(Et,{}):e.jsx(Ot,{}),onClick:()=>k(!h.showGrid),size:"small",type:h.showGrid?"primary":"default"})}),e.jsx(ee,{title:t("toggle_labels"),children:e.jsx(N,{icon:e.jsx(Lt,{}),onClick:()=>O(!h.showLabels),size:"small",type:h.showLabels?"primary":"default"})}),e.jsxs(X.Compact,{children:[e.jsx(N,{icon:e.jsx(Xe,{}),onClick:w,size:"small",disabled:m<=.3}),e.jsxs("span",{className:"px-2 text-xs leading-6 bg-gray-100 border-y",children:[Math.round(m*100),"%"]}),e.jsx(N,{icon:e.jsx(Ye,{}),onClick:G,size:"small",disabled:m>=3})]}),e.jsx(ee,{title:t("fullscreen"),children:e.jsx(N,{icon:e.jsx(Mt,{}),onClick:L,size:"small"})}),e.jsxs(N.Group,{size:"small",children:[e.jsx(N,{icon:e.jsx(re,{}),onClick:P,disabled:!o,children:t("export_svg")}),e.jsx(N,{icon:e.jsx(re,{}),onClick:H,disabled:!o,children:t("export_png")})]})]}),styles:{body:{padding:0,height:"calc(100% - 60px)"}},children:e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-600 mb-1",children:t("grid_size")}),e.jsx(vt,{min:10,max:50,value:h.gridSize,onChange:T})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ne,{checked:h.showLabels,onChange:O,size:"small"}),e.jsx("span",{className:"ml-2",children:t("show_labels")})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ne,{checked:h.showPinNumbers,onChange:$,size:"small"}),e.jsx("span",{className:"ml-2",children:t("show_pin_numbers")})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ne,{checked:i,size:"small",disabled:!0}),e.jsx("span",{className:"ml-2 text-gray-400",children:t("edit_mode")})]})]})}),e.jsx("div",{ref:a,className:`border rounded-lg overflow-auto ${h.theme==="dark"?"border-gray-600":"border-gray-300"}`,style:{height:"500px",backgroundColor:h.theme==="dark"?"#1a1a1a":"#ffffff"},children:s?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:t("generating_schematic")})]})}):o&&o.components.length>0?e.jsx("div",{className:"p-4",children:f()}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Se,{className:"text-4xl mb-4 text-gray-300"}),e.jsx("p",{children:t("no_schematic")}),e.jsx("p",{className:"text-sm",children:t("visual_schematic_hint")})]})})}),i&&e.jsxs("div",{className:"mt-4 p-3 border rounded-lg",children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(We,{}),t("component_library")]}),e.jsx("div",{className:"grid grid-cols-4 md:grid-cols-8 gap-2",children:Q.getAllSymbols().map(c=>e.jsx(ee,{title:c.name,children:e.jsxs("div",{className:"p-2 border rounded cursor-pointer hover:bg-blue-50 hover:border-blue-300 text-center",onClick:()=>{S.info(t("selected_symbol",{name:c.name}))},children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:`<svg width="30" height="20" viewBox="0 0 ${c.width} ${c.height}">${c.svgPath}</svg>`}}),e.jsx("div",{className:"text-xs mt-1 text-gray-600",children:c.name})]})},c.id))})]}),o&&e.jsxs("div",{className:"mt-4 flex justify-between items-center text-xs text-gray-500 border-t pt-2",children:[e.jsxs("div",{children:[t("canvas_size"),": ",o.bounds.width," × ",o.bounds.height," px"]}),e.jsxs("div",{children:[t("scale_label"),": ",Math.round(m*100),"% |",t("grid_label"),": ",h.showGrid?t("status_on"):t("status_off")," |",t("theme_label"),": ",h.theme==="dark"?t("theme_dark"):t("theme_light")]})]})]})})},as=({bomData:r=[],loading:s=!1,editable:i=!1})=>{const{t}=ne(),[a]=y.useState(r),[m,u]=y.useState(""),[o,l]=y.useState(!0),[h,I]=y.useState(!1),g=f=>f.id===m,C=f=>{u(f.id)},z=()=>{u("")},G=async()=>{u(""),S.success(t("saved_success"))},w=()=>{if(a.length===0){S.warning(t("no_data_to_export"));return}const c=[["序号","标号","元件名称","参数值","封装","数量","制造商","型号","供应商","单价","小计","描述"].join(","),...a.map((E,pe)=>[pe+1,`"${E.reference.join(", ")}"`,`"${E.component}"`,`"${E.value}"`,`"${E.package||""}"`,E.quantity,`"${E.manufacturer||""}"`,`"${E.partNumber||""}"`,`"${E.supplier||""}"`,E.price||0,(E.price||0)*E.quantity,`"${E.description||""}"`].join(","))].join(`
`),d=new Blob([c],{type:"text/csv;charset=utf-8"}),p=URL.createObjectURL(d),v=document.createElement("a");v.href=p,v.download=`BOM_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(p),S.success(t("exported_bom_csv"))},j=()=>{S.info(t("pdf_export_wip"))},k=f=>{S.info(t("purchasing_lookup",{name:f.component}))},T=()=>a.reduce((f,c)=>f+(c.price||0)*c.quantity,0),O=()=>{const f={};return a.forEach(c=>{const d=$(c.component);f[d]=(f[d]||0)+c.quantity}),f},$=f=>{const c=f.toLowerCase();return c.includes("电阻")||c.includes("resistor")?"电阻":c.includes("电容")||c.includes("capacitor")?"电容":c.includes("电感")||c.includes("inductor")?"电感":c.includes("二极管")||c.includes("diode")?"二极管":c.includes("晶体管")||c.includes("transistor")?"晶体管":c.includes("集成电路")||c.includes("ic")||c.includes("芯片")?"集成电路":"其他"},P=()=>{if(!o||a.length===0)return null;const f=O(),c=T(),d=a.reduce((p,v)=>p+v.quantity,0);return e.jsxs(te,{className:"mb-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:a.length}),e.jsx("div",{className:"text-sm text-gray-500",children:t("kinds_of_components")})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:d}),e.jsx("div",{className:"text-sm text-gray-500",children:t("total_quantity")})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:["¥",c.toFixed(2)]}),e.jsx("div",{className:"text-sm text-gray-500",children:t("estimated_cost")})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:Object.keys(f).length}),e.jsx("div",{className:"text-sm text-gray-500",children:t("component_categories")})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(f).map(([p,v])=>e.jsxs(ye,{color:"geekblue",className:"mb-1",children:[p,": ",v]},p))})})]})},H=[{title:t("table_index"),dataIndex:"index",key:"index",width:60,render:(f,c,d)=>d+1},{title:t("table_ref"),dataIndex:"reference",key:"reference",width:120,render:f=>e.jsx("div",{className:"flex flex-wrap gap-1",children:f.map((c,d)=>e.jsx(ye,{color:"blue",className:"text-xs",children:c},d))})},{title:t("table_component"),dataIndex:"component",key:"component",width:120,render:(f,c)=>e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:f}),c.description&&e.jsx("div",{className:"text-xs text-gray-500",children:c.description})]})},{title:t("table_value"),dataIndex:"value",key:"value",width:100,render:f=>e.jsx("span",{className:"font-mono text-blue-600",children:f})},{title:t("table_package"),dataIndex:"package",key:"package",width:80},{title:t("table_qty"),dataIndex:"quantity",key:"quantity",width:80,render:(f,c)=>g(c)?e.jsx(De,{min:1,defaultValue:f,size:"small",style:{width:"100%"}}):e.jsx("span",{className:"font-semibold",children:f})},{title:t("table_manufacturer"),dataIndex:"manufacturer",key:"manufacturer",width:100,render:(f,c)=>g(c)?e.jsx(q,{defaultValue:f,size:"small",placeholder:t("table_manufacturer")}):e.jsx("span",{children:f||"-"})},{title:t("table_partnumber"),dataIndex:"partNumber",key:"partNumber",width:120,render:(f,c)=>g(c)?e.jsx(q,{defaultValue:f,size:"small",placeholder:t("table_partnumber")}):e.jsx("span",{className:"font-mono",children:f||"-"})},{title:t("table_supplier"),dataIndex:"supplier",key:"supplier",width:100},{title:t("table_price"),dataIndex:"price",key:"price",width:80,render:(f,c)=>g(c)?e.jsx(De,{min:0,precision:2,defaultValue:f,size:"small",style:{width:"100%"}}):e.jsx("span",{className:"text-green-600",children:f?`¥${f.toFixed(2)}`:"-"})},{title:t("table_subtotal"),key:"subtotal",width:80,render:(f,c)=>{const d=(c.price||0)*c.quantity;return e.jsx("span",{className:"text-green-600 font-semibold",children:d>0?`¥${d.toFixed(2)}`:"-"})}}];i&&H.push({title:t("actions"),key:"action",width:120,render:(f,c)=>g(c)?e.jsxs(X,{children:[e.jsx(N,{icon:e.jsx(Ae,{}),onClick:()=>G(),size:"small",type:"primary"}),e.jsx(N,{onClick:z,size:"small",children:t("cancel_text")})]}):e.jsxs(X,{children:[e.jsx(N,{icon:e.jsx(We,{}),onClick:()=>C(c),size:"small"}),e.jsx(N,{icon:e.jsx(He,{}),onClick:()=>k(c),size:"small",type:"text"})]})});const L=T();return e.jsx("div",{className:"h-full",children:e.jsx(te,{title:t("bom_title"),className:"h-full",extra:e.jsxs(X,{children:[e.jsx(N,{onClick:()=>l(!o),size:"small",type:o?"primary":"default",children:t("stats")}),e.jsx(N,{onClick:()=>I(!h),size:"small",type:h?"primary":"default",children:t("group")}),e.jsx(N,{icon:e.jsx(re,{}),onClick:w,size:"small",children:t("export_csv")}),e.jsx(N,{icon:e.jsx(re,{}),onClick:j,size:"small",type:"primary",children:t("export_pdf")})]}),styles:{body:{padding:0}},children:e.jsxs("div",{className:"p-4",children:[P(),a.length===0?e.jsxs("div",{className:"text-center py-20 text-gray-500",children:[e.jsx(He,{className:"text-4xl mb-4"}),e.jsx("p",{children:t("no_bom")}),e.jsx("p",{className:"text-sm",children:t("bom_hint")})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ht,{columns:H,dataSource:a,rowKey:"id",loading:s,scroll:{x:1200,y:400},size:"small",pagination:{showSizeChanger:!0,showQuickJumper:!0,showTotal:(f,c)=>t("show_total_range",{start:c[0],end:c[1],total:f})}}),L>0&&e.jsxs("div",{className:"mt-4 p-3 bg-green-50 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"text-green-700",children:t("total_cost_estimate")}),e.jsxs("span",{className:"text-2xl font-bold text-green-600",children:["¥",L.toFixed(2)]})]}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:t("price_disclaimer")})]})]})})})};class ls{constructor(){ke(this,"storageKey","circuitsai_projects")}getProjects(){try{const s=localStorage.getItem(this.storageKey);return s?JSON.parse(s).map(t=>{var a;return{...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),chatHistory:((a=t.chatHistory)==null?void 0:a.map(m=>({...m,timestamp:new Date(m.timestamp)})))||[]}}):[]}catch(s){return console.error("Failed to load projects:",s),[]}}saveProject(s){const i=this.getProjects(),t={...s,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return i.push(t),this.saveProjects(i),t}updateProject(s,i){const t=this.getProjects(),a=t.findIndex(u=>u.id===s);if(a===-1)return null;const m={...t[a],...i,updatedAt:new Date};return t[a]=m,this.saveProjects(t),m}deleteProject(s){const i=this.getProjects(),t=i.filter(a=>a.id!==s);return t.length===i.length?!1:(this.saveProjects(t),!0)}getProject(s){return this.getProjects().find(t=>t.id===s)||null}exportProject(s){const i=JSON.stringify(s,null,2),t=new Blob([i],{type:"application/json"}),a=URL.createObjectURL(t),m=document.createElement("a");m.href=a,m.download=`${s.name.replace(/[^a-zA-Z0-9]/g,"_")}_${s.id}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(a)}async importProject(s){return new Promise((i,t)=>{const a=new FileReader;a.onload=m=>{var u;try{const o=(u=m.target)==null?void 0:u.result,l=JSON.parse(o);if(!l.name)throw new Error("Invalid project format: missing name");const h=this.saveProject({name:l.name,description:l.description,circuitData:l.circuitData,bomData:l.bomData,chatHistory:l.chatHistory,tags:l.tags});i(h)}catch(o){t(new Error("Failed to parse project file: "+o.message))}},a.onerror=()=>t(new Error("Failed to read file")),a.readAsText(s)})}searchProjects(s){const i=this.getProjects(),t=s.toLowerCase();return i.filter(a=>{var m,u;return a.name.toLowerCase().includes(t)||((m=a.description)==null?void 0:m.toLowerCase().includes(t))||((u=a.tags)==null?void 0:u.some(o=>o.toLowerCase().includes(t)))})}getProjectStats(){const s=this.getProjects(),i=s.length,t=s.filter(o=>{var l;return(l=o.circuitData)==null?void 0:l.ascii}).length,a=s.filter(o=>o.bomData&&o.bomData.length>0).length,m={};s.forEach(o=>{var l;(l=o.tags)==null||l.forEach(h=>{m[h]=(m[h]||0)+1})});const u=Object.entries(m).sort(([,o],[,l])=>l-o).slice(0,5).map(([o,l])=>({tag:o,count:l}));return{totalProjects:i,totalCircuits:t,totalBOMs:a,mostUsedTags:u,recentProjects:s.sort((o,l)=>l.updatedAt.getTime()-o.updatedAt.getTime()).slice(0,5)}}saveProjects(s){try{localStorage.setItem(this.storageKey,JSON.stringify(s))}catch(i){throw console.error("Failed to save projects:",i),new Error("Failed to save project: storage quota exceeded")}}cleanupOldProjects(s=90){const i=this.getProjects(),t=new Date;t.setDate(t.getDate()-s);const a=i.filter(u=>u.updatedAt>=t),m=i.length-a.length;return m>0&&this.saveProjects(a),m}}const ie=new ls,{TextArea:cs}=q,{Search:ds}=q,ms=({visible:r,onClose:s,onLoadProject:i,currentProjectData:t})=>{var c,d;const[a,m]=y.useState([]),[u,o]=y.useState([]),[l,h]=y.useState(""),[I,g]=y.useState(!1),[C,z]=y.useState({name:"",description:"",tags:[]}),[G,w]=y.useState(!1);y.useEffect(()=>{r&&j()},[r]),y.useEffect(()=>{if(l.trim()){const p=ie.searchProjects(l);o(p)}else o(a)},[l,a]);const j=()=>{try{const p=ie.getProjects();m(p),o(p)}catch{S.error("加载项目列表失败")}},k=async()=>{var p;if(!C.name.trim()){S.error("请输入项目名称");return}if(!(t!=null&&t.circuitData)&&!((p=t==null?void 0:t.chatHistory)!=null&&p.length)){S.error("当前没有可保存的内容");return}w(!0);try{ie.saveProject({name:C.name,description:C.description,circuitData:t.circuitData,bomData:t.bomData,chatHistory:t.chatHistory,tags:C.tags}),S.success("项目保存成功"),g(!1),z({name:"",description:"",tags:[]}),j()}catch(v){S.error("保存项目失败："+v.message)}finally{w(!1)}},T=p=>{i&&(i(p),S.success(`已加载项目：${p.name}`),s())},O=p=>{try{ie.deleteProject(p),S.success("项目删除成功"),j()}catch{S.error("删除项目失败")}},$=p=>{try{ie.exportProject(p),S.success("项目导出成功")}catch{S.error("导出项目失败")}},P=async p=>{w(!0);try{await ie.importProject(p),S.success("项目导入成功"),j()}catch(v){S.error("导入项目失败："+v.message)}finally{w(!1)}return!1},H=p=>p.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),L=p=>{var E;let v=0;return(E=p.circuitData)!=null&&E.ascii&&(v+=40),p.bomData&&p.bomData.length>0&&(v+=30),p.chatHistory&&p.chatHistory.length>2&&(v+=30),Math.min(v,100)},f=ie.getProjectStats();return e.jsxs(e.Fragment,{children:[e.jsxs(Be,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{}),"项目管理"]}),open:r,onCancel:s,width:900,footer:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(X,{children:[e.jsx(Ct,{accept:".json",showUploadList:!1,beforeUpload:P,children:e.jsx(N,{icon:e.jsx(Rt,{}),loading:G,children:"导入项目"})}),e.jsx(N,{type:"primary",icon:e.jsx(Ae,{}),onClick:()=>g(!0),disabled:!(t!=null&&t.circuitData)&&!((c=t==null?void 0:t.chatHistory)!=null&&c.length),children:"保存当前项目"})]}),e.jsx(N,{onClick:s,children:"关闭"})]}),children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs(te,{size:"small",className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:f.totalProjects}),e.jsx("div",{className:"text-sm text-gray-500",children:"总项目数"})]}),e.jsxs(te,{size:"small",className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:f.totalCircuits}),e.jsx("div",{className:"text-sm text-gray-500",children:"已设计电路"})]}),e.jsxs(te,{size:"small",className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:f.totalBOMs}),e.jsx("div",{className:"text-sm text-gray-500",children:"已生成BOM"})]})]}),e.jsx(ds,{placeholder:"搜索项目名称、描述或标签...",value:l,onChange:p=>h(p.target.value),style:{marginBottom:16},prefix:e.jsx(Ft,{})})]}),e.jsx("div",{style:{maxHeight:500,overflowY:"auto"},children:u.length===0?e.jsx(W,{description:"暂无项目",image:W.PRESENTED_IMAGE_SIMPLE,children:e.jsx(N,{type:"primary",onClick:()=>g(!0),disabled:!(t!=null&&t.circuitData)&&!((d=t==null?void 0:t.chatHistory)!=null&&d.length),children:"保存第一个项目"})}):e.jsx(Z,{dataSource:u.sort((p,v)=>v.updatedAt.getTime()-p.updatedAt.getTime()),renderItem:p=>{var v;return e.jsx(Z.Item,{actions:[e.jsx(ee,{title:"加载项目",children:e.jsx(N,{icon:e.jsx(et,{}),onClick:()=>T(p),size:"small"})}),e.jsx(ee,{title:"导出项目",children:e.jsx(N,{icon:e.jsx(re,{}),onClick:()=>$(p),size:"small"})}),e.jsx(kt,{title:"确定要删除这个项目吗？",description:"此操作不可恢复",onConfirm:()=>O(p.id),okText:"删除",cancelText:"取消",okType:"danger",children:e.jsx(N,{icon:e.jsx(Vt,{}),danger:!0,size:"small"})})],children:e.jsx(Z.Item.Meta,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:p.name}),e.jsx(Nt,{percent:L(p),size:"small",style:{width:100},format:()=>""})]}),description:e.jsxs("div",{children:[p.description&&e.jsx("p",{className:"text-gray-600 mb-2",children:p.description}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{children:[e.jsx(Gt,{})," 更新于 ",H(p.updatedAt)]}),((v=p.circuitData)==null?void 0:v.ascii)&&e.jsx("span",{children:"📋 有电路图"}),p.bomData&&p.bomData.length>0&&e.jsx("span",{children:"📦 有BOM表"})]}),p.tags&&p.tags.length>0&&e.jsx("div",{className:"flex gap-1",children:p.tags.map(E=>e.jsx(ye,{color:"blue",children:E},E))})]})]})})})}})})]}),e.jsx(Be,{title:"保存项目",open:I,onCancel:()=>g(!1),onOk:k,confirmLoading:G,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"项目名称 *"}),e.jsx(q,{placeholder:"输入项目名称",value:C.name,onChange:p=>z({...C,name:p.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"项目描述"}),e.jsx(cs,{placeholder:"描述项目的用途和特点",value:C.description,onChange:p=>z({...C,description:p.target.value}),rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"标签 (用逗号分隔)"}),e.jsx(q,{placeholder:"如：电源, LED, 放大器",onChange:p=>{const v=p.target.value.split(",").map(E=>E.trim()).filter(E=>E);z({...C,tags:v})}})]}),e.jsx("div",{className:"text-sm text-gray-500",children:"将保存当前的电路设计、BOM表格和对话历史"})]})})]})},{Sider:hs,Content:ps}=Ie,us=()=>{const r=jt(),{t:s}=ne(),[i,t]=y.useState(),[a,m]=y.useState([]),[u,o]=y.useState(!1),[l,h]=y.useState(!1),[I,g]=y.useState([]),[C,z]=y.useState(null),[G,w]=y.useState("ascii"),j=P=>{t(P),o(!1)},k=P=>{if(P.items){const H=P.items.map((L,f)=>({id:`bom_${f+1}`,reference:[L.component],component:L.component,value:L.value||"",package:L.package,quantity:L.quantity,price:L.price,description:`${L.component} 元件`}));m(H)}},T=P=>{g(P)},O=P=>{z(P),P.circuitData&&t(P.circuitData),P.bomData&&m(P.bomData),P.chatHistory&&g(P.chatHistory),S.success(`已加载项目: ${P.name}`)},$=()=>({name:(C==null?void 0:C.name)||"",description:(C==null?void 0:C.description)||"",circuitData:i,bomData:a,chatHistory:I});return e.jsxs(Ie,{className:"h-screen",children:[e.jsxs("div",{className:"bg-white border-b px-4 py-2 flex justify-between items-center shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(N,{icon:e.jsx(Ut,{}),onClick:()=>r("/"),type:"text",children:s("back_home")}),C&&e.jsxs("div",{className:"text-sm text-gray-600",children:[s("current_project"),": ",e.jsx("span",{className:"font-semibold",children:C.name})]})]}),e.jsxs(X,{children:[e.jsx(N,{icon:e.jsx(et,{}),onClick:()=>h(!0),children:s("project_manager")}),e.jsx(N,{type:"primary",icon:e.jsx(Ae,{}),onClick:()=>h(!0),disabled:!i&&I.length===0,children:s("save_project")})]})]}),e.jsxs(Ie,{children:[e.jsx(hs,{width:400,className:"bg-white border-r",children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-1",children:e.jsx(is,{onCircuitGenerated:j,onBomGenerated:k,onChatHistory:T,initialMessages:C==null?void 0:C.chatHistory})}),e.jsx("div",{className:"p-2 border-t",children:e.jsx(Dt,{slot:Kt.SLOTS.DESIGN_SIDEBAR,format:"rectangle",style:{display:"block",width:"100%",height:"250px"},className:"w-full"})})]})}),e.jsx(ps,{className:"bg-gray-50",children:e.jsx("div",{className:"p-4 h-full",children:e.jsxs(qt,{gutter:[16,16],className:"h-full",children:[e.jsx(Ke,{span:14,children:e.jsx(Ze,{activeKey:G,onChange:w,className:"h-full",items:[{key:"ascii",label:e.jsxs("span",{children:[e.jsx(Bt,{})," ",s("tab_ascii")]}),children:e.jsx(rs,{circuitData:i,loading:u})},{key:"visual",label:e.jsxs("span",{children:[e.jsx(Se,{})," ",s("tab_visual")]}),children:e.jsx(os,{circuitData:i,loading:u,editable:!1})}]})}),e.jsx(Ke,{span:10,children:e.jsx(as,{bomData:a,editable:!0})})]})})})]}),e.jsx(ms,{visible:l,onClose:()=>h(!1),onLoadProject:O,currentProjectData:$()})]})},_s=Object.freeze(Object.defineProperty({__proto__:null,default:us},Symbol.toStringTag,{value:"Module"}));export{_s as D,Jt as a};
//# sourceMappingURL=DesignPage-8f1067d5.js.map
